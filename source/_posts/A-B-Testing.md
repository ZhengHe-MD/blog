---
title: 你的 A/B 测试靠谱吗？
date: 2022-07-04 19:50:21
tags:
mathjax: true
---

最近，我们在公司内部做了一些 [Hacking Growth](https://www.goodreads.com/book/show/31625067-hacking-growth) 方向的探索，我们团队俨然成了增长团队，从用户增长、转化的各个环节上尝试不同的策略，拉新、激活、留存、促活、成单，整个核心流程是一个大漏斗，不同的阶段和渠道又可以拆分成不同的小漏斗，哪个环节损失大就优化哪个。但无论做何种尝试，都绕不开 A/B 测试。

对于一名工程师，我认为 A/B 测试有两个角度值得了解：

1. 如何搭建一个 A/B 测试平台，支持流量分层、转发，让不同实验共享流量；

2. 如何解读一个 A/B 测试的结果，从中得出正确的结论，指导后续生产实践；

对于前者，业界已经有许多最佳实践，比如之前引我入门的这篇论文 [Overlapping Experiment Infrastructure](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36500.pdf)，以及伴鱼的小伙伴们写的两篇实践总结 [[1](https://xie.infoq.cn/article/d62fed8fdfdf87ec1d9779f79)]、[[2](https://tech.ipalfish.com/blog/2020/06/25/ab_test_evolu/)]；本文想聊的是后者，**如何解读 A/B 测试的结果**？

## 建立直觉：怎么定义「更好」

A/B 测试，顾名思义就是有 A 和 B 两种方案，测试的目的就是要知道「A 更好还是 B 更好」。假设现在的场景是给一个用户群在同样的时间拨打智能电话，对其中的一半用户使用话术 A，另一半使用话术 B，拨打后的结果只有两种：有意向和无意向。意向率就是意向用户总数与接通用户总数之比。

如果话术 A 比话术 B 更好，是否意味着无论执行多少次实验，话术 A 的意向率永远高于话术 B？换一个例子：A 选手和 B 选手在世界羽联的排名分别是世界第一和世界第二，是否意味着：

1. A 选手与 B 选手交战，A 选手总是能获胜

2. B 选手如果能胜过 C 选手 (排名第三或之后)，A 选手也必然能胜过 C 选手

事实并非如此，我们能观察到的只是： A 选手和所有对手的交手战绩 (获胜积分) 要略优于 B 选手。回到话术 A 与话术 B，话术 A 比话术 B 更好，只意味着，如果做很多次实验，话术 A 能在更多次的实验中能取得比话术 B 更高的意向率，而在单次实验中，话术 B 仍然可能取得比话术 A 更高的意向率。

> 💡「更好」是概率更高的好，而不是绝对的好。

定义了「更好」，就不难定义「好的程度」。在 100 次实验中，考虑下列两种情况：

1. 话术 A 有 60 次取得比话术 B 更高的意向率

2. 话术 A 有 90 次取得比话术 B 更高的意向率

不难想象，在第二种情况下，话术 A 「好的程度」更大一些，而更大的程度就意味着更充足的信心。假设结论是「话术 A 比话术 B 更好」，那么观测到 2 肯定比观测到 1 更靠谱。因为 情况 1 可能由一些随机因素引发，比如恰好在本次实验中使用 A 话术拨打的用户中正在开会的多一些。但这些随机因素出现很难呈现一边倒的情况，因此情况 2 不太可能由类似的因素引发。

## 假设检验 - 以 Permutation Test 为例

在上一节中，我们建立了 A/B 测试中关于「更好」的直觉，本节就来比较正式地分析一个具体场景 ——

**实验结果**：假设其它条件相当，我们用 A 话术和 B 话术分别拨打 10000 通电话，其中 A 话术接通了 3469 通，B 话术接通了 2798 通。在 A 话术接通的电话中，有 98 位用户有意向；而在 B 话术接通的电话中，有 43 位用户有意向。

这里电话是否接通与话术无关，因此我们只关心接通电话的意向情况。上述实验结果可以总结为下表：

|     | A     | B     |
| --- | ----- | ----- |
| 接通  | 3469  | 2798  |
| 意向  | 98    | 43    |
| 意向率 | 2.83% | 1.54% |

从绝对数值上看，A 话术的意向率要高于 B 话术，似乎意味着 A 话术更好，那这次实验的结果是个巧合吗？基于此，我们的假设如下：

* 零假设：话术 A 没有比话术 B 更好

* 备择假设：话术 A 比话术 B 更好

下面使用的假设检验方法叫 Permutation Test，主要因为它[很符合直觉，没有参数，不(已)需(经)要(忘)公(光)式(光)](https://www.jwilber.me/permutationtest/)。Permutation Test 做的事情很简单，就是把当前的意向用户 (98+43=141) 重新随机打散分配到池子 (3469+2798 = 6267) 中，然后从池子中随机取 3469 个用户归属于 A 话术，剩下的归属于 B 话术，这就是一次随机的模拟实验。假设模拟实验后有 X 个用户归属于 A 话术，Y 个用户归属于 B 话术，那么 X 和 Y 满足：

$$
X + Y = 141, X \ge 0, Y \ge 0
$$

如果重复做 10000 次这样的模拟实验，并以 X-Y (这里以 X-Y、Y-X、X 或者 Y 为例皆可) 的值为横坐标，出现频次 `Freq(X-Y)` 为纵坐标，就很容易得到一个类似正态分布的钟型曲线：

![X 频率直方图](./freq-x.png)

它就是随机变量 X-Y 的频度直方图，理论上它的形状应该趋近于变量 X-Y 的概率密度函数。有了 X-Y 的频度直方图，我们就可以找到本节初提到的实验结果 (x-y = 55) 在直方图中的位置：

![加上标记的 X 频率直方图](./freq-x-with-mark.png)

利用 x-y 在频度直方图中的位置，我们就能估算出 x-y 在随机变量 X-Y 概率密度函数上的分位点。在一次模拟实验中，我们算得的分位点为 0.05%，这意味着「如果零假设成立，观测到 x 的概率为 0.05%」，即做一万次实验，只有五次能观测到 x-y >= 55。这是个小概率事件，我们有信心选择拒绝零假设，相信备择假设，如果一定要给这个信心加一个数字，那么我希望是 99.95% (1-0.05%)。

如果你听过蒙特卡洛方法 (Monte Carlo Method)，刚才这个过程就是一次蒙特卡洛模拟。实现逻辑可以参考我的这篇 gist [AB-Permutation-Test · GitHub](https://gist.github.com/ZhengHe-MD/48e633ec49a35b5259908cf468dc073b)。

## 参考

* [Hacking Growth](https://www.goodreads.com/book/show/31625067-hacking-growth)

* [The Permutation Test]([Permutation Test: Visual Explanation](https://www.jwilber.me/permutationtest/))

* [Statistical Significance in A/B testing (Calculation, p-value and the Math)](https://data36.com/statistical-significance-in-ab-testing/)

* [AB-Permutation-Test · GitHub](https://gist.github.com/ZhengHe-MD/48e633ec49a35b5259908cf468dc073b)
