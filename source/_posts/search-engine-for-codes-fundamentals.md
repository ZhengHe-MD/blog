---
title: ä»£ç æœç´¢å¼•æ“ï¼šåŸºç¡€ç¯‡
date: 2021-05-09 10:19:17
tags:
- system design
---

> å®Œæ•´è°ƒç ”æŠ¥å‘Šè¯·è§æˆ‘ä¸ªäººçš„ Notion [ç¬”è®°](https://www.notion.so/Code-Search-Engine-e1391cd82b3e490aa05edabdf7ceacd7)

# 0. å¼•å…¥

æœ€è¿‘ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸¤ä¸ªåœºæ™¯ï¼š

1. è´Ÿè´£åŸºç¡€æœåŠ¡çš„å·¥ç¨‹å¸ˆæƒ³ä¸‹çº¿ä¸€ä¸ªæ¥å£ä½†ä¸çŸ¥é“æœ‰å“ªäº›æœåŠ¡è°ƒç”¨
2. è´Ÿè´£ APM ç³»ç»Ÿçš„å·¥ç¨‹å¸ˆæƒ³çŸ¥é“ä»»æ„ RPC æ¥å£çš„æ‰€æœ‰ä¸Šæ¸¸è°ƒç”¨æ–¹

ä»”ç»†åˆ†æä¸éš¾å‘ç°ï¼ŒäºŒè€…çš„æœ¬è´¨éƒ½åœ¨äºã€Œç»´æŠ¤å¾®æœåŠ¡é—´çš„é™æ€ä¾èµ–å…³ç³»ã€ã€‚ç­‰ç­‰ï¼åœ¨è°ƒç”¨é“¾è¿½è¸ªç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¸æ˜¯å·²ç»è·å¾—äº†æ¥å£çº§åˆ«çš„ä¾èµ–å…³ç³»å—ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨é‚£è¾¹çš„æ•°æ®ï¼Ÿç›®å‰ä¼´é±¼è°ƒç”¨é“¾è¿½è¸ªç³»ç»Ÿä¸­ç»´æŠ¤çš„ä¾èµ–å…³ç³»åœ¨ä¸‰ä¸ªæ–¹é¢æ— æ³•æ»¡è¶³ä¸Šè¿°éœ€æ±‚ï¼š

1. ä¸€äº›ä¸Šå¤æœåŠ¡ä»ç„¶åœ¨è¿è¡Œï¼Œä½†æ²¡æœ‰æ¥å…¥è°ƒç”¨é“¾è¿½è¸ªç³»ç»Ÿ
2. è°ƒç”¨é“¾è¿½è¸ªç³»ç»Ÿä¸­ç»´æŠ¤çš„æ˜¯ã€ŒåŠ¨æ€ä¾èµ–å…³ç³»ã€ï¼Œå³æœ€è¿‘ N å¤© (ç”± retention policy å†³å®š) æ•è·çš„è°ƒç”¨å…³ç³»
3. è°ƒç”¨é“¾è¿½è¸ªç³»ç»Ÿä¸­å­˜å‚¨çš„æ˜¯ç»é‡‡æ ·ç­–ç•¥è¿‡æ»¤åçš„æ•°æ®ï¼Œå¯èƒ½å­˜åœ¨æ¼é‡‡çš„æƒ…å†µ

äºæ˜¯æˆ‘ä»¬å¼€å§‹æ€è€ƒå¦ä¸€ä¸ªæ–¹å‘ï¼š**é€šè¿‡ä»£ç æœç´¢å¼•æ“æå–é™æ€ä¾èµ–å…³ç³»**ã€‚æ°å¥½åœ¨ 2020 Q4 æœ«ï¼Œæˆ‘ä»¬å°†å†…éƒ¨æ‰€æœ‰é¡¹ç›®ä»“åº“ä» Gerrit è¿ç§»åˆ°äº† Gitlabï¼Œä¸ºä»£ç æœç´¢å¼•æ“çš„è½åœ°é“ºå¹³äº†é“è·¯ã€‚

åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å’Œå¤§å®¶åˆ†äº«ä»£ç æœç´¢å¼•æ“çš„è°ƒç ”æŠ¥å‘Šï¼ŒæœŸæœ›èƒ½å¸®åŠ©è¯»è€…äº†è§£ä»£ç æœç´¢å¼•æ“å¦‚ä½•å·¥ä½œã€‚æŠ¥å‘Šä¸»è¦è®¨è®ºä»¥ä¸‹è¯é¢˜ï¼š

* ä¸ºä»€ä¹ˆåš
* ä¸€èˆ¬æ¶æ„
* è®¾è®¡å†³å®š
* å®ç°æŒ‘æˆ˜
* å¼€æºé¡¹ç›®

# 1. ä¸ºä»€ä¹ˆåš

Google å†…éƒ¨æ›¾å¯¹å·¥ç¨‹å¸ˆåšä¸€æ¬¡ [è°ƒç ”](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/43835.pdf)ï¼Œå‘ç°å¹³å‡æ¯ä½å·¥ç¨‹å¸ˆæ¯å¤©ä¼šè¿›è¡Œ 5.3 æ¬¡ä»£ç æœç´¢ä¼šè¯ (session)ï¼Œæ‰§è¡Œ 12 ä¸ªä»£ç æœç´¢è¯·æ±‚ (search quries)ï¼›åœ¨ Github/Gitlab ç­‰ä»“åº“æ‰˜ç®¡æœåŠ¡ä¸­ï¼Œæœç´¢æ˜¯å·¥ç¨‹å¸ˆæœ€å¸¸ç”¨çš„åŠŸèƒ½ä¹‹ä¸€ï¼›åœ¨ã€Œå¼•å…¥ã€ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä»‹ç»äº†ä¼´é±¼æ­å»ºä»£ç æœç´¢å¼•æ“çš„åˆè¡·ã€‚é‚£ä¹ˆåœ¨ä¸šç•Œçš„å®è·µä¸­ï¼Œä»£ç æœç´¢å¼•æ“ä¸»è¦è¢«ç”¨æ¥è§£å†³å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

å¸¸è§çš„ä»£ç æœç´¢åœºæ™¯åŒ…æ‹¬ï¼š

* ç†è§£ä»£ç é—´çš„ä¾èµ–å…³ç³»
* å¯»æ‰¾å³å°†å¼ƒç”¨ (deprecated) æ¥å£çš„å¼•ç”¨åœ°ç‚¹
* é¿å…é‡å¤é€ è½®å­
* åˆ†äº«ç¼–ç æ–¹æ¡ˆå’Œç¼–ç é£æ ¼
* å‘ç°ä½è´¨é‡çš„ä»£ç 
* å®šä½å®‰å…¨é—®é¢˜
* ...

å°½ç®¡æœåŠ¡å’Œä»“åº“ä¸ä¸€å®šæ˜¯ä¸€ä¸€æ˜ å°„å…³ç³»ï¼Œä½†å¦‚æœæœåŠ¡è¢«æ‹†åˆ†ï¼Œé€šå¸¸ä»“åº“ä¹Ÿä¼šè¢«æ‹†åˆ†ï¼›æœåŠ¡æ‹†åˆ†åå¯è§‚æµ‹æ€§ (observability) ä¼šä¸‹é™ï¼Œä»“åº“è¢«æ‹†åˆ†åå¯è§‚æµ‹æ€§ä¹Ÿä¼šä¸‹é™ã€‚åœ¨ä»“åº“æ‹†åˆ†å‰ï¼Œæœç´¢ä»£ç åªéœ€è¦æ‰§è¡Œ `grep` å‘½ä»¤ï¼›ä»“åº“æ‹†åˆ†åï¼Œå·¥ç¨‹å¸ˆè¿å…¬å¸å†…éƒ¨å­˜åœ¨å“ªäº›ä»“åº“éƒ½æ— æ³•å‡†ç¡®çŸ¥é“ï¼Œæ›´ä¸ç”¨è¯´ clone åˆ°æœ¬åœ°è¿›è¡Œæœç´¢ã€‚å› æ­¤ä»£ç æœç´¢å¼•æ“å®é™…ä¸Šæ˜¯ä¸€ç§æé«˜ä»“åº“å¯è§‚æµ‹æ€§çš„å·¥å…·ã€‚

# 2. ä¸€èˆ¬æ¶æ„

<img src="./anatomy.png" width="680px" />

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»£ç æœç´¢å¼•æ“é€šå¸¸å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šWeb Server å’Œ Index Sererã€‚

Web Server è´Ÿè´£æ¸²æŸ“æŸ¥è¯¢é¡µé¢ï¼Œæ¥æ”¶ç”¨æˆ·çš„æŸ¥è¯¢è¯·æ±‚ï¼Œå°†æŸ¥è¯¢è°ƒåº¦åˆ°åˆé€‚çš„ Index Server ä¸­ï¼Œè·å–æŸ¥è¯¢ç»“æœï¼Œå¹¶è¿”å›åˆ°å‰ç«¯å‘ç”¨æˆ·å±•ç¤ºã€‚Index Server è´Ÿè´£ä»ä»“åº“æ‰˜ç®¡æœåŠ¡ä¸­æŒ‰ç»™å®šçš„ç­–ç•¥æ‹‰å–ç›¸å…³ä»“åº“æ•°æ®åˆ°æœ¬åœ°å¹¶å»ºç«‹ç´¢å¼•ã€‚å½“ä»“åº“æ•°æ®æ›´æ–°æ—¶ï¼Œéœ€è¦åŒæ­¥ä»“åº“å˜åŠ¨ï¼Œæ›´æ–°ç´¢å¼•ï¼Œä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚å½“ä»“åº“æ•°é‡è¿‡å¤šï¼Œç´¢å¼•ä½“ç§¯è¿‡å¤§æ—¶ï¼ŒIndex Server éœ€è¦æ”¯æŒæ¨ªå‘æ‰©å±•ï¼Œåˆ†ç‰‡ç®¡ç†æ•°æ®ï¼›å½“è¯·æ±‚æ•°é‡è¿‡å¤šæ—¶ï¼ŒWeb Server ä¹Ÿéœ€è¦æ”¯æŒæ¨ªå‘æ‰©å±•ã€‚

å®è·µä¸­ï¼Œæœ‰çš„é¡¹ç›®ä¼šå°† Web Server å’Œ Index Server åˆè€Œä¸ºä¸€ï¼Œæœ‰çš„ä¼šå°† Index Server çš„ä»“åº“åŒæ­¥å’Œç´¢å¼•å»ºç«‹è¿›ä¸€æ­¥æ‹†åˆ†æˆä¸¤ä¸ªæ¨¡å—ï¼Œç”šè‡³å°†ä»“åº“å’Œç´¢å¼•çš„å…ƒæ•°æ®ç”¨å…³ç³»å‹æ•°æ®åº“å•ç‹¬ç®¡ç†ï¼Œä½†è¿™ä¸€åˆ‡éƒ½èƒ½å¤Ÿä»¥ã€Œä¸€èˆ¬æ¡†æ¶ã€ä¸ºèµ·ç‚¹è®¾è®¡ã€‚

# 3. è®¾è®¡å†³å®š

äº†è§£äº†ä»£ç æœç´¢å¼•æ“çš„ä¸€èˆ¬æ¶æ„åï¼Œæˆ‘ä»¬ä»ä»¥ä¸‹å››ä¸ªè§’åº¦å‡ºå‘ï¼Œè®¨è®ºè¯¥ç³»ç»Ÿå„ä¸ªæ¨¡å—çš„è®¾è®¡å†³å®šï¼š

* æŸ¥è¯¢è¯­è¨€
* ç´¢å¼•ç»“æ„
* æ•°æ®ç®¡ç†
* ç»“æœæ’åº

## 3.1 æŸ¥è¯¢è¯­è¨€

<img src="./query-languages.png" width="480px" />

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»£ç æœç´¢å¼•æ“çš„æŸ¥è¯¢è¯­è¨€é€šå¸¸ç”±ä¸¤éƒ¨åˆ†æ„æˆï¼šã€Œä¿®é¥°è¯ã€å’Œã€ŒåŒ¹é…å™¨ã€ã€‚ã€Œä¿®é¥°è¯ã€ç”¨æ¥åˆ¶å®šæŸ¥è¯¢çš„èŒƒå›´ï¼Œå¦‚ä»“åº“åç§°ã€æ–‡ä»¶åç§°ã€ç¼–ç¨‹è¯­è¨€ç­‰ç­‰ã€‚å®ƒæ—¢ç”¨äºå¸®åŠ©ç”¨æˆ·æ›´ç²¾ç¡®åœ°æè¿°æŸ¥è¯¢å†…å®¹ï¼Œä¹Ÿèƒ½å¤Ÿä¸ºæœç´¢å¼•æ“æ›´é«˜æ•ˆåœ°æ‰§è¡Œæä¾›çº¿ç´¢ã€‚ã€ŒåŒ¹é…å™¨ã€åˆ™æ˜¯å¯¹ç›®æ ‡ä»£ç ç‰¹å¾çš„è¡¨è¿°ï¼Œå®ƒå¯ä»¥æ˜¯å…³é”®è¯ (keyword)ã€å­ä¸² (substring)ã€æ­£åˆ™è¡¨è¾¾å¼ (regular expression)ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ…å«ç¼–ç¨‹è¯­è¨€ç‰¹å¾çš„ç»“æ„åŒ– (structural) æè¿°ã€‚

ä¸¾ä¾‹å¦‚ä¸‹ï¼šè¯­å¥

```sh
r:kubernetes b:master common.*Describe
```

è¡¨ç¤ºçš„æ˜¯ï¼šæœç´¢ kubernetes ä»“åº“ master åˆ†æ”¯ä¸­ï¼ŒåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ `common.*Describe` çš„æºç ã€‚å†çœ‹çœ‹ã€ŒåŒ¹é…å™¨ã€ï¼Œå‡è®¾æœ‰ä¸€ä¸ªæ–‡æ¡£ (document) å†…å®¹å¦‚ä¸‹ï¼š

```go
func greeting() {
  fmt.Println("hello world")
}
```

é€šè¿‡å…³é”®è¯åŒ¹é…ï¼Œä½ å¯ä»¥æœç´¢å•è¯ï¼Œå¦‚ "greeting"ï¼Œæˆ–è¯ç»„ï¼Œå¦‚ "hello world"ï¼Œæœç´¢åˆ°è¯¥æ–‡æ¡£ï¼Œä½†æ— æ³•é€šè¿‡æœç´¢å­ä¸²ï¼Œå¦‚ "greet" æˆ– "Print" è¾¾åˆ°ç›®çš„ï¼›é€šè¿‡å­å­—ç¬¦ä¸²åŒ¹é…ï¼Œä½ å¯ä»¥æœç´¢ä»»æ„å­ä¸²ï¼Œå¦‚ "greet"ã€"Print"ï¼Œå½“ç„¶è·¨è¶Šå•è¯çš„å­ä¸²ä¹Ÿæ²¡é—®é¢˜ï¼Œå¦‚ "ello wor"ï¼›é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½ çš„æè¿°å¯ä»¥æ›´åŠ çµæ´»ï¼Œå¦‚æ‰€æœ‰åŒ…å« ctx å‚æ•°çš„å‡½æ•°å¯ä»¥æœç´¢ "^func.*ctx"ã€‚å…³é”®è¯ã€å­å­—ç¬¦ä¸²ã€æ­£åˆ™è¡¨è¾¾å¼çš„è¡¨è¾¾åŠ›ä¾æ¬¡é€’å¢ï¼Œä½†ä¸‰è€…éƒ½å±äºçº¯æ–‡æœ¬åŒ¹é…å™¨ã€‚å¦‚æœæƒ³åŸºäºç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„æ¥æœç´¢ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»“æ„åŒ–åŒ¹é…å™¨ã€‚ä¾‹å¦‚åœ¨ Sourcegraph ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹åŒ¹é…å™¨ï¼š

```
switch :[[v]] := :[x].(type) {:[_] case nil: :[_]}
```

æ¥åŒ¹é… Go æºç ä¸­ type switch ä»£ç å—ä¸­åŒ…å« nil case çš„æƒ…å†µã€‚

## 3.2 ç´¢å¼•ç»“æ„

ä»£ç æœç´¢å¼•æ“ä¹‹äºé€šç”¨æ–‡æœ¬æœç´¢å¼•æ“ï¼Œå°±å¦‚æ—¶åºæ•°æ®åº“ä¹‹äºå…³ç³»å‹æ•°æ®åº“ï¼Œå‰è€…æ˜¯åè€…çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚å› æ­¤é©±åŠ¨ä»£ç æœç´¢å¼•æ“çš„è®¸å¤šç´¢å¼•ç»“æ„æºäºé€šç”¨æ–‡æœ¬æœç´¢å¼•æ“ã€‚

<img src="./indexes.png" width="680px"/>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥å°†ä»£ç æœç´¢å¼•æ“å¸¸ç”¨çš„ç´¢å¼•ç»“æ„åˆ†ä¸ºä¸¤ç±»ï¼šã€ŒåŸºäºæ–‡æœ¬ã€ (text-based) å’Œã€Œè¯­è¨€æ„ŸçŸ¥ã€ (language-aware)ã€‚åŸºäºæ–‡æœ¬çš„ç´¢å¼•ç»“æ„åªå¯¹è¯­æ–™åšçº¯æ–‡æœ¬åˆ†æï¼Œè€Œè¯­è¨€æ„ŸçŸ¥çš„ç´¢å¼•ç»“æ„éœ€è¦ç†è§£ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œå‰è€…é€‚ç”¨äºæ‰€æœ‰æ–‡æœ¬æœç´¢å¼•æ“ï¼Œåè€…åˆ™ä¸ºä»£ç æœç´¢å¼•æ“ç‰¹æœ‰ã€‚

æœ¬èŠ‚æˆ‘ä»¬é¦–å…ˆå›é¡¾ä¸€ä¸‹ã€Œå€’æ’ç´¢å¼•ã€çš„åŸºç¡€çŸ¥è¯†ï¼Œéšåä¾æ¬¡è®¨è®ºä¸Šå›¾å¶å­èŠ‚ç‚¹ä¸­çš„ç´¢å¼•ç»“æ„ã€‚

### 3.2.1 å€’æ’ç´¢å¼•

æ–‡æœ¬æœç´¢çš„å®ç°ç¦»ä¸å¼€ä¸€ä¸ªç»å…¸çš„æ•°æ®ç»“æ„ â€” å€’æ’ç´¢å¼• (Inverted Index)ã€‚æœ¬èŠ‚ç®€å•å›é¡¾å€’æ’ç´¢å¼•çš„åŸºæœ¬ç»“æ„ä»¥åŠå®ƒçš„ä¸€äº›åŸºæœ¬å˜ä½“ã€‚å¦‚æœä½ å¯¹è¿™ä¸ªè¯é¢˜æœ‰å…´è¶£æ·±å…¥äº†è§£ï¼Œæˆ‘æ¨èå¼—è±å ¡å¤§å­¦çš„ Information Retrieval è¯¾ç¨‹ ([è§†é¢‘](https://www.youtube.com/playlist?list=PLfgMNKpBVg4V8GtMB7eUrTyvITri8WF7i) | [èµ„æ–™](https://github.com/ZhengHe-MD/ir-freiburg))ã€‚

ç»™å®šå¦‚ä¸‹ä¸€ç»„æ–‡æ¡£ (documents)ï¼š

1. He likes to wink, he likes to drink.
2. He likes to drink, and drink, and drink.
3. The thing he likes to drink is ink.
4. He likes to wink and drink pink ink.

å…¶ä¸­åºå·å³ä¸ºæ–‡æ¡£ç¼–å·ã€‚æœ€ç®€å•çš„å€’æ’ç´¢å¼•å°±æ˜¯å…ˆå¯¹å…¶åˆ†è¯ï¼Œæ‰¾å‡ºæ¯ä¸ªå•è¯å¯¹åº”çš„æ–‡æ¡£åˆ—è¡¨ï¼š

```json
{
  "and": [2, 4],
  "drink": [1, 2, 3, 4],
  "he": [1, 2, 3, 4],
  "ink": [3, 4],
  "is": [3],
  "likes": [1, 2, 3, 4],
  "the": [3],
  "thing": [3],
  "to": [1, 2, 4],
  "wink": [1, 4]
}
```

åœ¨ç›¸å…³ä¹¦ç±ä¸­ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„è¢«ç§°ä¸º Posting Lists æˆ– Postingsã€‚ä¸ºäº†ç®—æ³•å®ç°ä¸Šçš„é«˜æ•ˆï¼Œæ¯ä¸ªå•è¯å¯¹åº”çš„æ–‡æ¡£åºå·åˆ—è¡¨é€šå¸¸æŒ‰é¡ºåºæ’åˆ—ã€‚

æœ‰äº†ä¸Šè¿°ç»“æ„ï¼Œæˆ‘ä»¬å°±èƒ½æ”¯æŒç®€å•çš„ã€Œå…³é”®è¯æœç´¢ã€(Keyword Search) åŠŸèƒ½ã€‚å‡å¦‚ç”¨æˆ·æƒ³æŸ¥è¯¢åŒ…å«å•è¯ "wink" çš„æ–‡æ¡£ï¼Œå°±æ‰¾åˆ°å•è¯ "wink" å¯¹åº”çš„æ–‡æ¡£åˆ—è¡¨å³å¯ã€‚ä¸Šè¿°ç»“æ„ä¹Ÿèƒ½æ”¯æŒã€Œè¯ç»„æœç´¢ã€ (Phrase Search)ï¼Œæ¯”å¦‚ "likes to"ï¼Œå°±å¯ä»¥åˆ†åˆ«æ‰¾åˆ° "likes" å’Œ "to" å¯¹åº”çš„æ–‡æ¡£åˆ—è¡¨ï¼Œå–äºŒè€…äº¤é›†ã€‚ä½†å¯¹äºè¿™äº›ç­›é€‰å‡ºæ¥çš„æ–‡æ¡£ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†è¿›è¡Œä¸€éç¡®è®¤ï¼Œå› ä¸º "likes" å’Œ "to" å‡ºç°çš„ä½ç½®å’Œé¡ºåºéƒ½æ— æ³•ä¿è¯ç¬¦åˆè¦æ±‚ï¼Œæ¯”å¦‚æ–‡æ¡£ "To my mind, I likes the way you achieve this"ã€‚

å¦ä¸€ç§æ”¯æŒçš„ã€Œè¯ç»„æœç´¢ã€ çš„æ–¹æ³•æ˜¯åœ¨ Postings ä¸­åŠ å…¥æ¯ä¸ªè¯è¯­å‡ºç°çš„ä½ç½®ä¿¡æ¯ï¼Œå¦‚ï¼š

```json
{
  "drink": {
    "1": [30],
    "2": [13, 24, 35],
    "3": [23],
    "4": [22]
  },
  // ...
}
```

é€šå¸¸ç§°è¿™ç§ Postings ä¸º Positional Postingsã€‚è¿™æ—¶æ”¯æŒã€Œè¯ç»„æœç´¢ã€å°±æ˜¯å°èœä¸€ç¢Ÿäº†ï¼Œå…¸å‹çš„ç©ºé—´æ¢æ—¶é—´ã€‚

å¦‚æœç”¨æˆ·è®°ä¸ä½å®Œæ•´çš„å•è¯å’Œè¯ç»„ï¼Œæ€ä¹ˆåŠï¼Ÿè¿™å°±éœ€è¦æ”¯æŒä¸€ç§æ–°çš„æœç´¢æ–¹å¼ â€”ã€Œå­ä¸²æœç´¢ã€(Substring Search)ï¼Œå¦‚æœç´¢ "ink"ï¼Œè¦ç»™å‡º "drink"ã€"wink" å’Œ "ink" çš„ç»“æœå¹¶é›†ã€‚æ˜¾ç„¶ï¼Œæ¯æ¬¡éå† Postings ä¸­çš„æ‰€æœ‰ key æ•ˆç‡ä¸é«˜ï¼Œå°¤å…¶æ˜¯éœ€è¦åšå¤šè¯­è¨€æ”¯æŒçš„æ—¶å€™ï¼Œé‚£ä¹ˆä¸€ä¸ªå¸¸ç”¨çš„æŠ€å·§å°±æ˜¯ q-gram (æˆ– n-gram)ã€‚gram å°±æ˜¯è‹¥å¹²è¿ç»­å­—ç¬¦çš„é›†åˆï¼Œè€Œå‰é¢çš„ q æˆ– n è¡¨ç¤ºçš„æ˜¯è¿ç»­çš„å­—ç¬¦ä¸ªæ•°ï¼Œ2-gram å°±æ˜¯å­—ç¬¦çš„ä¸¤ä¸¤ç»„åˆï¼Œ3-gram (trigram) å°±æ˜¯ä¸‰ä¸ªå­—ç¬¦çš„ä»»æ„ç»„åˆï¼Œä¾æ¬¡ç±»æ¨ã€‚æ¯”å¦‚å­—ç¬¦ä¸² "freiburg" åŒ…å«çš„æ‰€æœ‰ 3-gram åŒ…æ‹¬ï¼š

```
$$f, $fr, fre, rei, eib, ibu, bur, urg, rg$, g$$
```

è€Œ q-gram index å°±æ˜¯æŠŠå‰é¢çš„ Postings ä¸­çš„è¯è¯­æ¢æˆè¿™äº› q-gramã€‚é‚£ä¹ˆæŸ¥è¯¢å­ä¸² "reibur" å°±å¯ä»¥è½¬åŒ–ä¸ºæŸ¥è¯¢```rei AND eib AND ibu AND bur```ã€‚

> ğŸ’¡ ç•™ä¸ªæ€è€ƒï¼šå¦‚æœæƒ³æ”¯æŒæ¨¡ç³Šæ£€ç´¢è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

ä»¥ä¸Šæ˜¯å¯¹å€’æ’ç´¢å¼•çš„ç®€å•å›é¡¾ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®¨è®ºä»£ç æœç´¢å¼•æ“å¸¸ç”¨çš„ç´¢å¼•ç»“æ„ã€‚

### 3.2.2 Trigram

Russ Cox åœ¨åšå®¢ [How Google Code Search Worked](https://swtch.com/~rsc/regexp/regexp4.html) ä¸­æå‡ºç”¨ Trigram ç´¢å¼•æ¥æ”¯æŒä»£ç æœç´¢ï¼Œå…¶ç»“æ„ä¸ 3.2.1 èŠ‚ä¸­ä»‹ç»çš„ 3-gram å®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

> â“ä¸ºä»€ä¹ˆæ˜¯ 3-gramï¼Œè€Œä¸æ˜¯ 2-gram æˆ– 4-gram
>
> In practice, there are too few distinct 2-grams and too many distinct 4-grams, so 3-grams (trigrams) it is. â€” Russ Cox

### 3.2.3 Positional Trigram

Positional Trigram ä¸ Trigram é—´çš„å…³ç³»å°±æ˜¯ Positional Postings ä¸ Postings é—´çš„å…³ç³»ï¼ŒåŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "${trigram}": {
    "${doc_id}": [1, 3] // positions
  }
}
```

å³åœ¨ Trigram Index çš„åŸºç¡€ä¸Šå¢åŠ ä½ç½®ä¿¡æ¯ã€‚

### 3.2.4 Suffix Array

ä¸€ä¸ªå­—ç¬¦ä¸²çš„ Suffix Array æ˜¯å®ƒæ‰€æœ‰åç¼€å­ä¸²æŒ‰å­—å…¸åºæ’åˆ—çš„æ•°ç»„ã€‚å‡è®¾ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² "hello world"ï¼š

![](./suffix-array-example-1.png)

å®ƒçš„æ‰€æœ‰åç¼€å­ä¸²åŒ…å«ï¼š"hello world"ã€"ello world"ã€"llo world" ç­‰ç­‰ï¼Œæ’åºåå¾—åˆ°ï¼š

![](./suffix-array-example-2.png)

æ‹¿åˆ°ä¸Šè¿°æ’åºç»“æ„åï¼ŒæŸ¥è¯¢å­ä¸²å°±å¯ä»¥è½¬åŒ–æˆäºŒåˆ†æŸ¥æ‰¾é—®é¢˜ã€‚

> ğŸ’¡ç•™ä¸ªæ€è€ƒï¼šå¦‚ä½•é«˜æ•ˆåœ°å­˜å‚¨ Suffix Array ç´¢å¼•ï¼Ÿéœ€è¦å­˜å‚¨æ‰€æœ‰å­ä¸²å—ï¼Ÿ

### 3.2.5 åŸºäºæ–‡æœ¬ç´¢å¼•çš„æŸ¥è¯¢è¿‡ç¨‹

æ— è®ºæ˜¯ Trigramã€Positional Trigram è¿˜æ˜¯ Suffix Arrayï¼Œå¦‚æœæƒ³æ”¯æŒé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æœç´¢ä»£ç ï¼Œéƒ½è¦å®ç°ä»¥ä¸‹æµç¨‹ï¼š

![](./text-based-query-process.png)

1. å°†æ­£åˆ™è¡¨è¾¾å¼è½¬åŒ–æˆå­ä¸²çš„ã€Œä¸ã€ã€ã€Œæˆ–ã€ç»„åˆ
2. å°†å­ä¸²çš„ç»„åˆæŸ¥è¯¢è½¬åŒ–æˆå¯¹åº”çš„ç´¢å¼•æŸ¥è¯¢ (Trigram, Positional Trigram, Suffix Array)
3. æ‰§è¡Œç´¢å¼•æŸ¥è¯¢ï¼Œè·å–å€™é€‰æ–‡æ¡£åˆ—è¡¨
4. å¯¹æ¯ä¸ªå€™é€‰æ–‡æ¡£æ‰§è¡Œå®é™…çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°†åŒ¹é…æˆåŠŸçš„ç»“æœè¿”å›

ç”±äºç¬¬ 1 æ­¥å’Œç¬¬ 2 æ­¥å¯èƒ½ä¸æ˜¯ç­‰ä»·è½¬æ¢ï¼Œå› æ­¤éœ€è¦é€šè¿‡ç¬¬ 4 æ­¥å¾—åˆ°ç²¾ç¡®çš„æŸ¥è¯¢ç»“æœã€‚è¿™é‡Œé—®é¢˜çš„éš¾ç‚¹åœ¨äºï¼š**å¦‚ä½•å°†æ­£åˆ™è¡¨è¾¾å¼è½¬åŒ–æˆå­ä¸²çš„ã€Œä¸ã€ã€ã€Œæˆ–ã€ç»„åˆ**ã€‚

ä¸¾ä¸€äº›ç®€å•çš„ä¾‹å­ï¼š

* `/Google.*Search/` â†’ `Google AND Search`
* `(Path|PathFragment).*=.*/usr/local` â†’ `("Path" OR "PathFragment") AND "/usr/local"`

éœ€è¦å…³æ³¨çš„æ˜¯ï¼Œç¬¬ 1ã€2 æ­¥çš„é€‰æ‹©æ€§è¶Šå¤§ï¼Œç¬¬ 4 æ­¥çš„æˆæœ¬å°±è¶Šå°ï¼Œå› æ­¤è½¬åŒ–æ–¹æ¡ˆçš„å¥½åå–å†³äºå…¶è½¬åŒ–æ•ˆç‡å’Œç»“æœæŸ¥è¯¢çš„é€‰æ‹©æ€§ã€‚å¯¹è¿™ä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œå¯ä»¥æ·±å…¥äº†è§£ä¸šç•Œçš„è§£å†³æ–¹æ¡ˆï¼š

* [Google Code Search](https://swtch.com/~rsc/regexp/regexp4.html)
* [Zoekt](https://github.com/google/zoekt/blob/master/doc/design.md)
* [Livegrep](https://blog.nelhage.com/2015/02/regular-expression-search-with-suffix-arrays/)
* [Regular Expression Search via Graph Cuts](https://blog.aaw.io/2016/06/10/regrams-intro.html)

### 3.2.6 Ctags

Ctags æ˜¯ unix æˆ– unix-like ç³»ç»Ÿä¸­å†…ç½®çš„å·¥å…·ï¼Œä¸ºæºç ä»“åº“ç”Ÿæˆã€Œè¯­è¨€å¯¹è±¡ã€ (language objects) çš„ç´¢å¼•ã€‚ç›®å‰ä»åœ¨ç»´æŠ¤çš„ç‰ˆæœ¬æ˜¯ Universal Ctagsï¼Œæƒ³äº†è§£æ›´å¤šç»†èŠ‚å¯ä»¥é˜…è¯»å®ƒçš„[å®˜æ–¹æ–‡æ¡£](https://docs.ctags.io/en/latest/index.html)ã€‚

ä»¥æˆ‘çš„ä¸€ä¸ªç©å…·é¡¹ç›®ã€Œ[Zhenghe-MD/regexgo](https://github.com/ZhengHe-MD/regexgo)ã€ä¸ºä¾‹ï¼Œæ‰§è¡Œï¼š

```sh
$ git clone https://github.com/ZhengHe-MD/regexgo.git
$ cd regexgo && ctags **/*.go
```

å°±èƒ½åœ¨ regexgo æ–‡ä»¶å¤¹ä¸­çœ‹åˆ°ä¸€ä¸ª tags æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```
MatchString	nfa.go	/^func MatchString(n *nfa, word string, options *Mat/
TestBackTracking	nfa_test.go	/^func TestBackTracking(t *testing.T) {$/
TestNFASearch	nfa_test.go	/^func TestNFASearch(t *testing.T) {$/
TestToPostfix	parser_test.go	/^func TestToPostfix(t *testing.T) {$/
addEpsilonTransition	nfa.go	/^func addEpsilonTransition(from *state, to *state) /
addTransition	nfa.go	/^func addTransition(from, to *state, symbol byte) {/
backtracking	nfa.go	/^func backtracking(s *state, visited map[*state]int/
const	nfa.go	/^const ($/
import	nfa_test.go	/^import ($/
nfaSearch	nfa.go	/^func nfaSearch(n *nfa, word string) bool {$/
toPostfix	parser.go	/^func toPostfix(exp string) string {$/
```

æ¯è¡Œæ•°æ®æ˜¯ä¸€ä¸ª `(language object, file, regexp matcher)` ä¸‰å…ƒç»„ã€‚Ctags å¸¸å¸¸è¢«ç”¨äº IDE å®ç°å®šä¹‰è·³è½¬çš„åŠŸèƒ½ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«é›†æˆåˆ°ä»£ç æœç´¢å¼•æ“ä¸­ï¼Œæ›´å¥½åœ°æœåŠ¡äºã€Œè¯­è¨€æ„ŸçŸ¥ã€çš„æŸ¥è¯¢ã€‚

Ctags èƒŒåç”±ä¸åŒç¼–ç¨‹è¯­è¨€çš„è§£æå™¨ (parser) é©±åŠ¨ï¼Œåè€…çš„åŸç†åˆ™æ˜¯å¦ä¸€ä¸ªè¯é¢˜ï¼Œä¸åœ¨æœ¬æ–‡ä¸­è®¨è®ºã€‚

### 3.2.7 LSIF

ä» Ctags çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼ŒCtags ä¸­è®°å½•çš„ã€Œè¯­è¨€å¯¹è±¡ã€ä¿¡æ¯é‡å¾ˆå°ï¼ŒåŸºæœ¬ä¸Šåªæœ‰å‡½æ•°ä¿¡æ¯ã€‚è¦æ”¯æŒè¡¨è¾¾åŠ›æ›´å¼ºçš„ã€Œè¯­è¨€æ„ŸçŸ¥ã€æŸ¥è¯¢ï¼Œå…¶è®°å½•çš„ä¿¡æ¯è¿˜è¿œè¿œä¸å¤Ÿã€‚åœ¨æ•°æ®æ¨¡å‹å’Œä¿¡æ¯é‡ä¸Šï¼ŒLSIF æ¯” Ctags èµ°å¾—æ›´è¿œï¼š

>The goal of the LSIF is to support rich code navigation in development tools or Web UI without needing a local copy of the source code.  â€” [LSP/LSIF docs](https://microsoft.github.io/language-server-protocol/overviews/lsif/overview/)

ç”±äº LSIF çš„è®¾è®¡ç›®çš„æ˜¯æ”¯æŒä¸°å¯Œçš„ä»£ç è·³è½¬èƒ½åŠ›ï¼Œå› æ­¤å®ƒéœ€è¦è®°å½•åŒ…æ‹¬å˜é‡å®šä¹‰ã€å¼•ç”¨ï¼Œå‡½æ•°çš„å®šä¹‰ã€è°ƒç”¨åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚LSIF æ˜¯å°†è¿™äº›å®ä½“ï¼ŒåŠå®ä½“ä¹‹é—´çš„å…³ç³»ç”¨å›¾ç»“æ„æ¥å»ºæ¨¡ã€‚ä»¥ä¸‹æ˜¯ Chris Wendt åœ¨ GopherCon 2019 ä¸Šé¢˜ä¸ºã€Œ[LSIF + Go](https://www.youtube.com/watch?v=fMIRKRj_A88)ã€ä¸­çš„å…¶ä¸­ä¸€å¼  slideï¼Œå…¶ä¸­çº¢è‰²æ¡†æ¡†ä¸ºå›¾çš„ç‚¹ï¼Œç»¿è‰²çº¿ä¸ºå›¾çš„è¾¹ã€‚

<img src="./lsif-example.png" with="680px" />

å°†è¿™å¼ å›¾è®°å½•åˆ°ç´¢å¼•ä¸­ï¼Œå°±å¯ä»¥åœ¨å¿…è¦çš„æ—¶å€™æŒ‰ã€Œå›¾ã€ç´¢éª¥ï¼Œæ”¯æŒä¸°å¯Œçš„ã€Œè¯­è¨€æ„ŸçŸ¥ã€æŸ¥è¯¢ã€‚ä»¥ä¸‹æ˜¯ LSIF çš„ç´¢å¼•æ–‡ä»¶æ•°æ®ç¤ºä¾‹ï¼š

```json
//...
{"id":6,"type":"vertex","label":"definitionResult"}
{"id":7,"type":"edge","label":"next","outV":4,"inV":5}
{"id":8,"type":"edge","label":"textDocument/definition","outV":5,"inV":6}
{"id":9,"type":"edge","label":"item","outV":6,"inVs":[4],"document":3}
{"id":10,"type":"vertex","label":"hoverResult","result":{"contents":[{"language":"go","value":"package \"fmt\""},"Package fmt implements ... \n\n"]}}
{"id":11,"type":"edge","label":"textDocument/hover","outV":5,"inV":10}
{"id":12,"type":"vertex","label":"range","start":{"line":4,"character":5},"end":{"line":4,"character":12}}
{"id":13,"type":"vertex","label":"resultSet"}
{"id":14,"type":"vertex","label":"definitionResult"}
//...
```

## 3.3 æ•°æ®ç®¡ç†

ä»£ç æœç´¢å¼•æ“éœ€è¦ç®¡ç†ä¸¤ç»„æ•°æ®ï¼šä»“åº“å’Œç´¢å¼•ã€‚æ ¹æ®ä½¿ç”¨åœºæ™¯éœ€è¦ï¼Œå¼•æ“å¯ä»¥å°†å®ƒä»¬å­˜å‚¨åœ¨ HDD æˆ– SSD ä¸Šï¼Œå¹¶åœ¨æœåŠ¡çš„æ—¶å€™è½½å…¥å¿…è¦çš„éƒ¨åˆ†åˆ°å†…å­˜ä¸­ã€‚å› ä¸ºæ•°æ®æ¨¡å‹æ¯”è¾ƒç®€å•ï¼Œä»£ç æœç´¢å¼•æ“ä¼šç›´æ¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ä»“åº“å’Œç´¢å¼•ã€‚

### 3.3.1 æ•°æ®åˆ†ç‰‡

å°±å¦‚æ—©æœŸçš„ Slack å¯ä»¥åŸºäº workspace_id éš”ç¦»è®¡ç®—ã€å­˜å‚¨èµ„æºï¼Œæ”¯æŒç³»ç»Ÿæ¨ªå‘æ‰©å±•ï¼Œä»£ç æœç´¢å¼•æ“ä¸­ä¹Ÿå­˜åœ¨è¿™æ ·ä¸€ä¸ªä¸œè¥¿ï¼Œå®ƒå°±æ˜¯ repo_idã€‚å®ƒæ—¢å¯ä»¥å¸®åŠ©æŸ¥è¯¢å¼•æ“ç¼©å°æœå¯»èŒƒå›´ï¼Œä¹Ÿå¯ä»¥å¸®åŠ©å­˜å‚¨å¼•æ“ç®¡ç†ä»“åº“å’Œç´¢å¼•æ•°æ®ã€‚

### 3.3.2 ä»“åº“

ä»“åº“é€šå¸¸è¢«æ‰˜ç®¡åœ¨äº‘æœåŠ¡ä¸­ï¼Œå¦‚ Githubã€Gitlabã€BitBucket ç­‰ç­‰ï¼Œå› æ­¤ä»£ç æœç´¢å¼•æ“çš„æ ¸å¿ƒå·¥ä½œä¹‹ä¸€å°±æ˜¯ä»æ‰˜ç®¡æœåŠ¡ä¸­åŒæ­¥ä»“åº“ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªå°çš„è®¾è®¡å†³å®šï¼šåŒæ­¥å†…å®¹å’ŒåŒæ­¥æ—¶æœºã€‚

#### åŒæ­¥å†…å®¹

ä»¥ Git ä¸ºä¾‹ï¼Œä½ å¯ä»¥é€‰æ‹© cloneã€shallow clone æˆ– bare cloneã€‚`git clone` ä¼šæ‹‰å–ä»“åº“çš„æ‰€æœ‰å†å²å¹¶ checkout åˆ°é»˜è®¤åˆ†æ”¯ (main/master) æœ€æ–°çš„ commit ä¸Šï¼›`git clone --depth=k` ä¼šæ‹‰å–ä»“åº“æœ€æ–°çš„ k ä¸ª commit æ•°æ®ï¼Œä¸¢å¼ƒä¹‹å‰çš„å†å²ï¼›`git clone --bare` åªæ‹‰å–ä»“åº“çš„ .git æ–‡ä»¶å¤¹ã€‚ä¸‰è€…çš„åŒºåˆ«ä½“ç°åœ¨æ‹‰å–æ•°æ®çš„å¤§å°å’Œä¿ç•™çš„ä»“åº“å†å²ä¿¡æ¯ä¸Šã€‚

#### åŒæ­¥æ—¶æœº

å¦‚æœä»£ç æœç´¢å¼•æ“éœ€è¦ä¸ºä¹‹å»ºç´¢å¼•çš„ä»“åº“æ•°é‡ä¸å¤šï¼Œå¯ä»¥ç®€å•çš„æŒ‰ç”¨æˆ·å¯¹å®æ—¶æ€§çš„è¦æ±‚å®šæœŸå…¨é‡æ‹‰å–ï¼Œå¦‚ 1 å°æ—¶ã€1 å¤©ç­‰ç­‰ï¼›å¦‚æœéœ€è¦ç´¢å¼•æ•´ä¸ª Github ä¸Šçš„å¤§éƒ¨åˆ†ï¼Œç”šè‡³æ‰€æœ‰å¼€æºé¡¹ç›®ï¼Œå°±éœ€è¦ç»“åˆäº‹ä»¶å›è°ƒã€åŠ¨æ€è°ƒæ•´æ›´æ–°é¢‘ç‡ç­‰å¤æ‚ç­–ç•¥æ§åˆ¶å„ä¸ªé¡¹ç›®çš„åŒæ­¥æ—¶æœºã€‚å¿…è¦çš„æ—¶å€™è¿˜éœ€å¼•å…¥å…³ç³»å‹æ•°æ®åº“å­˜å‚¨ç›¸å…³å…ƒæ•°æ®ã€‚

### 3.3.3 ç´¢å¼•

å¤§å¤šæ•°ä»£ç æœç´¢å¼•æ“çš„æ•°æ®ç®¡ç†æ¨¡å—ä¼šä»¥ä¸€ä¸ªç´¢å¼•æ–‡ä»¶å¯¹åº”ä¸€ä¸ªä»“åº“ï¼Œè¿™ä¸ä¸Šæ–‡æåˆ°çš„æ•°æ®åˆ†ç‰‡ç­–ç•¥ç›¸å…³ã€‚æœ‰äº›å¼•æ“ä¼šé€‰æ‹©åœ¨ç´¢å¼•æ–‡ä»¶ä¸­å†—ä½™ä¸€ä»½æºç ï¼Œä½¿å¾—æŸ¥è¯¢è¿‡ç¨‹å¯ä»¥å®Œå…¨åœ¨ç´¢å¼•æ–‡ä»¶ä¸­å®Œæˆï¼ŒåŒæ—¶å¯ä»¥å°†ä»“åº“ä¸ç´¢å¼•çš„ç®¡ç†è§£è€¦ã€‚å…¶ä¸­ä¸€ä¸ªå®ç°ä¸Šå¸¸è§çš„æŠ€å·§æ˜¯å°†æ¯ä¸ªä»“åº“çš„æ‰€æœ‰æºæ–‡ä»¶æŒ‰æŸä¸ªé¡ºåºè¿æ¥ (concatenate) èµ·æ¥ï¼Œç„¶åå†å¯¹æ•´ä¸ªå¤§æ–‡ä»¶å»ºç«‹ç´¢å¼•ï¼š

![](./index-of-repo.png)

åœ¨ç»å¤§å¤šæ•°æ—¶å€™ï¼Œç ”å‘å…³å¿ƒçš„æ˜¯ä»“åº“çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå› æ­¤ä¸€ä¸ªåŠ¡å®ä¸»ä¹‰çš„åšæ³•æ˜¯åªå¯¹æœ€æ–°çš„ç‰ˆæœ¬å»ºç«‹ç´¢å¼•ã€‚

>Indexing every branch of every repository isnâ€™t a pragmatic use of resources for most customers, so this decision balances optimizing the common case (searching all default branches) with space savings (not indexing everything). â€” [Sourcegraph](https://docs.sourcegraph.com/dev/background-information/architecture/index)

ä»“åº“å‘ç”Ÿå˜åŒ–åï¼Œæ•°æ®ç®¡ç†æ¨¡å—éœ€è¦å°†è¿™äº›å˜åŒ–åé¦ˆåˆ°ç´¢å¼•ä¸Šã€‚

## 3.4 ç»“æœæ’åº

å¯¹äºåƒ Google è¿™æ ·çš„æœç´¢å¼•æ“ï¼Œæ’åºæ˜¯éå¸¸é‡è¦çš„ä¸€ç¯ï¼ŒæŠŠç”¨æˆ·æœ€æƒ³è·å–çš„ä¿¡æ¯æŒ‰è´¨é‡ä»é«˜åˆ°ä½æ’åºå°±æ˜¯å®ƒçš„è®¾è®¡ç›®çš„ä¹‹ä¸€ã€‚å®é™…ä¸Šæ’åºè´¨é‡çš„è¡¡é‡èƒŒåæœ‰ä¸€ç³»åˆ—çš„ç†è®ºç ”ç©¶åœ¨æ”¯æ’‘ã€‚ç„¶è€Œï¼Œç›®å‰ç»å¤§å¤šæ•°å¼€æºä»£ç æœç´¢å¼•æ“å¹¶ä¸å¤ªå…³å¿ƒæ’åºï¼Œä¸ªäººè®¤ä¸ºå…¶åŸå› å¯èƒ½åœ¨äºï¼š

1. å¼€å‘è€…é€šå¸¸èƒ½éå¸¸ç²¾å‡†åœ°åœ¨æŸ¥è¯¢è¯­å¥ä¸­æè¿°è‡ªå·±æƒ³è¦çš„ä»£ç ï¼Œç”šè‡³åšåˆ° 100% çš„ precision å’Œ recall
2. ä»£ç æœç´¢å¼•æ“æœç´¢èŒƒå›´é€šå¸¸ä¸ºä¸€ä¸ªå…¬å¸æˆ–éƒ¨é—¨å†…éƒ¨çš„æ‰€æœ‰ä»“åº“ï¼Œæ•°é‡ä¸å¤šï¼Œç»“æœåˆ—è¡¨ä¸ä¼šå¾ˆé•¿

ä¸€äº›äº‘ç«¯ä»“åº“æ‰˜ç®¡æœåŠ¡ä¹Ÿæä¾›æœç´¢æœåŠ¡ï¼Œä»å®ƒä»¬çš„è§’åº¦è€ƒè™‘ï¼Œæ”¯æŒåŸºäºæµè¡Œåº¦ã€æ´»è·ƒåº¦ã€è¯é¢˜çš„æ’åºå°±å˜å¾—ç›¸å½“å¿…è¦ã€‚

# 4. å®ç°æŒ‘æˆ˜

æœ¬èŠ‚ä»‹ç»æ­å»ºä¸€ä¸ªä»£ç æœç´¢å¼•æ“å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚è¿™ä¸ªåˆ—è¡¨ä¼šéšç€æ—¥åçš„è°ƒç ”å’Œå®è·µ (å¦‚æœæœ‰çš„è¯) ç»§ç»­å¢è¡¥å†…å®¹ã€‚

## 4.1 Unicode

Zoekt é¡¹ç›®çš„ä½œè€…ï¼ŒGoogle å·¥ç¨‹å¸ˆ Han-Wen åœ¨ Gerrit Summit 2017 ä¸Šçš„ [åˆ†äº«](https://storage.googleapis.com/gerrit-talks/summit/2017/Zoekt%20-%20improved%20codesearch.pdf) ä¸­æ›¾ç»ä»‹ç»è¿‡ï¼Œåœ¨ä»–å¼€å‘ç¬¬ä¸€ç‰ˆ Zoekt æ—¶ï¼Œåªè€ƒè™‘äº†æºç ä¸­çš„ ascii å­—ç¬¦ï¼Œå½“ä»–æœŸæœ›æ‰©å¤§é¡¹ç›®é€‚ç”¨èŒƒå›´ï¼Œæ”¯æŒ unicode æ—¶ï¼Œå‘ç°è‡ªå·±ä»¥å‰æœ‰å¾ˆå¤šé€»è¾‘ä¸å†é€‚ç”¨ã€‚å› ä¸º unicode çš„æ¯ä¸ªå­—ç¬¦çš„é•¿åº¦ä¸å®šï¼Œä¸€äº›åŸºäºå­—ç¬¦ä¸²å­—èŠ‚é•¿åº¦çš„è®¡ç®—ä¸å†æˆç«‹ã€‚å¦‚æœä½ çš„ä»£ç æœç´¢å¼•æ“æ˜¯é¢å‘å„ç§è¯­è¨€çš„ï¼Œåœ¨å†™ä»£ç æ—¶éœ€è¦æ ¼å¤–ç•™æ„è¿™æ–¹é¢çš„è€ƒè™‘ã€‚

## 4.2 å®‰å…¨é—®é¢˜

å¯¹äºä¸€ä¸ªç»„ç»‡å†…éƒ¨çš„ä»£ç æœç´¢å¼•æ“æ¥è¯´ï¼Œæœ€å¤§çš„é£é™©å°±æ˜¯ä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€‚å¼€å‘è€…å¯èƒ½ä¼šæ— æ„åœ°å°†ä¸€äº› tokenã€ç§˜é’¥ã€é‚®ç®±ã€æ‰‹æœºå·ç­‰ç­‰ä¿¡æ¯æ”¾åˆ°æºç ä¸­ã€‚å°½ç®¡è¿™æ ·çš„é£é™©æœ¬æ¥ä¹Ÿå­˜åœ¨ï¼Œä½†ä»£ç æœç´¢å¼•æ“çš„å­˜åœ¨æ”¾å¤§äº†æ³„æ¼é£é™©ã€‚

## 4.3 åˆ†é¡µ

å‡å¦‚ä¸€ä¸ªæœç´¢è¯·æ±‚å‘½ä¸­çš„æ–‡æ¡£å¾ˆå¤šï¼Œç”¨æˆ·åœ¨å‰ç«¯å°±å¸Œæœ›èƒ½å¤Ÿåˆ†é¡µæŸ¥è¯¢ã€‚ä»£ç æœç´¢å¼•æ“æ”¯æŒåˆ†é¡µæ¯”åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­æ”¯æŒåˆ†é¡µè¦éš¾ä¸€äº›ï¼Œå› ä¸ºä½ æ°¸è¿œæ— æ³•çŸ¥é“ä¸€ä¸ªä¸´æ—¶çš„æŸ¥è¯¢ä¼šåœ¨ä¸€ä¸ªä»“åº“åŒ¹é…å¤šå°‘æ¬¡ï¼Œä½ ä¹Ÿæ— æ³•ä¸ºæ­¤æå‰å»ºç«‹ç²¾ç¡®çš„ç´¢å¼•ã€‚å¦‚æœå¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹ [Sourcegraph å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜](https://docs.sourcegraph.com/dev/background-information/architecture/search-pagination)ã€‚

# 5. å¼€æºé¡¹ç›®

æœ¬èŠ‚ä»‹ç»çš„é¡¹ç›®åœ¨æ—¶é—´çº¿ä¸Šæ’åˆ—å¦‚ä¸‹ï¼š

![](./history-timeline.png)

å…¶ä¸­ Google Code Search ç®—æ˜¯è¿™ä¸ªé¢†åŸŸçš„å¼€å±±ä¹‹ä½œï¼Œåç»­çš„é¡¹ç›®éƒ½æ˜¯ ã€Œinspired by Russ Cox's workã€ğŸ˜†ã€‚

## 5.1 Google Code Search

>âš ï¸ æœ¬èŠ‚çš„å¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäº Russ Cox çš„åšå®¢ [How Google Code Search Worked](https://swtch.com/~rsc/regexp/regexp4.html)ã€‚

### 5.1.1 ä¸€ç‚¹å†å²

å¦‚æœè¿™ä¸ªä¸–ç•Œè¦æ±‚å¿…é¡»æœ‰ä¸€äº›å·¥ç¨‹å¸ˆæ¥ç ”ç©¶ä»£ç æœç´¢å·¥å…·ï¼Œé‚£ä¹ˆåæœ‰å…«ä¹è¿™äº›å·¥ç¨‹å¸ˆæ¥è‡ª Googleã€‚2006 å¹´å¤å¤©ï¼ŒRuss Cox æ¥åˆ° Google å®ä¹ ã€‚å½“æ—¶ï¼ŒGoogle å†…éƒ¨æœ‰ä¸€ä¸ªå«ä½œã€Œgsearchã€çš„é¡¹ç›®ç”¨äºä»£ç æœç´¢ï¼Œå®ƒçš„å®ç°å¯ä»¥ç®€å•åœ°ç†è§£æˆåˆ†å¸ƒå¼ grepï¼Œå³å¯åŠ¨å¤šå°æœºå™¨å­˜å‚¨ä¸åŒçš„ä»“åº“é›†åˆï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶å°† grep å‘½ä»¤ä¸‹å‘åˆ°å„ä¸ªæœºå™¨ï¼Œæ¯ä¸ªæœºå™¨åœ¨æœ¬åœ°æ‰§è¡Œ grep åè¿”å›ï¼Œå¹¶å°†ç»“æœæ±‡æ€»ã€‚

Russ Cox çš„ mentorï¼ŒJeff Dean åœ¨ä»–å¼€å§‹å®ä¹ æ—¶è¯´ï¼šã€Œå¦‚æœèƒ½åšä¸€ä¸ªæ”¯æŒæœç´¢å…¨ä¸–ç•Œå¼€æºä»£ç çš„å·¥å…·ï¼Œæ˜¯ä¸æ˜¯å¾ˆé…·ï¼Ÿã€åœ¨å½“å¹´ 10 æœˆï¼Œè¿™ä¸ªé¡¹ç›® Google Code Search ç»ˆäº[ä¸Šçº¿](http://googlecode.blogspot.com/2006/10/search-worlds-public-source-code.html)ã€‚

### 5.1.2 æŸ¥è¯¢è¯­è¨€

 Google Code Search æ”¯æŒé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼ŒRuss Cox æè¿°è¿™ç§æŸ¥è¯¢ä¸ºã€Œgeekily great but a very small nicheã€ã€‚Russ Cox å¼€æºçš„æ ¸å¿ƒä»£ç å¹¶æ²¡æœ‰æ”¯æŒé€šè¿‡ã€Œä¿®é¥°è¯ã€æ¥ç¼©çŸ­æ£€ç´¢èŒƒå›´ï¼Œè€Œåªæ˜¯æä¾›äº†ç±»ä¼¼ grep çš„å‘½ä»¤è¡Œå·¥å…·ã€‚è¿™å¤§æ¦‚æ˜¯å› ä¸ºå¼€æºå‡ºæ¥çš„[ä»£ç ](https://github.com/google/codesearch)è¶³ä»¥å±•ç¤ºä¸€ä¸ªä»£ç æœç´¢å¼•æ“çš„è¿è¡Œé€»è¾‘ï¼Œå‰©ä¸‹çš„å°±è®©æœ‰å…´è¶£çš„å¼€å‘è€…è‡ªè¡Œæ‰©å±•ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå€¼å¾—ä¸€æçš„å°æ’æ›²ï¼ŒRuss Cox åœ¨é¡¹ç›®çš„æ¦‚å¿µéªŒè¯é˜¶æ®µä¸­å‘ç°å¤§éƒ¨åˆ†æ‰‹å¤´çš„æ­£åˆ™è¡¨è¾¾å¼å¼•æ“éƒ½ä¸èƒ½ä¿è¯çº¿æ€§æ—¶ç©ºå¤æ‚åº¦ï¼Œå› ä¸ºå®ƒä»¬ä½¿ç”¨çš„æ˜¯å›æº¯æ³• (backtracking) è€Œéæœ‰é™è‡ªåŠ¨æœº (finite automata)ã€‚å°½ç®¡ Google Code Search ä½¿ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼å¼•æ“ä»ç„¶æ˜¯ [Plan 9 grep](https://9fans.github.io/plan9port/man/man1/grep.html) ä¸­çš„å®ç°ï¼Œè‹¥å¹²å¹´åï¼Œè¿™ä¸ªå¼•æ“ç»ˆäºè¢«æ›¿æ¢æˆäº† [RE2](https://github.com/google/re2)ã€‚å½“ç„¶ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ˜¯å¦ä¸€ä¸ªæœ‰è¶£çš„è¯é¢˜ï¼Œä½†ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ï¼Œæœ‰å…´è¶£å¯ä»¥å…ˆè¯»ä¸€ä¸‹ Russ Cox çš„ [æ­£åˆ™è¡¨è¾¾å¼ç³»åˆ—åšå®¢](https://swtch.com/~rsc/regexp/)ã€‚

### 5.1.3 ç´¢å¼•

 Google Code Search ä½¿ç”¨çš„æ˜¯æœ€åŸºæœ¬çš„ Trigram Indexã€‚ç´¢å¼•æœ¬èº«å¹¶æ— å¤æ‚ä¹‹å¤„ï¼Œå®é™…èŠ±è´¹ Russ Cox å¤§é‡ç²¾åŠ›çš„æ˜¯ã€Œä»æ­£åˆ™è¡¨è¾¾å¼åˆ° Trigram æŸ¥è¯¢ã€çš„è½¬åŒ–ä¸Šã€‚

### 5.1.4 è¿è¡Œ

ä¸Šæ–‡ä»‹ç»è¿‡ï¼Œåœ¨ Google Code Search ä¸­ Russ Cox åªæä¾›äº†æœ¬åœ°çš„å¯æ‰§è¡Œå‘½ä»¤ï¼Œä¾›å¼€å‘è€…è¯•éªŒã€‚é¡¹ç›®æä¾›çš„å¯æ‰§è¡Œå‘½ä»¤åŒ…æ‹¬ cindexã€csearch å’Œ cgrepã€‚

cindexä¼šå¯¹æ‰€æœ‰è¾“å…¥çš„æºç æ–‡ä»¶ï¼Œå»ºç«‹ä¸€ä¸ªå•ç‹¬çš„ç´¢å¼•æ–‡ä»¶ï¼Œé»˜è®¤å­˜å‚¨åœ¨ `$HOME/.csearchindex` ä¸­ã€‚æ¯”å¦‚ï¼š

```sh
$ cindex $HOME/src /usr/include
```

ä¼šä¸º `$HOME/src` å’Œ `/usr/include` æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æºç æ–‡ä»¶å»ºç«‹ç´¢å¼•ã€‚å¦‚æœé‡å¤æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä¼šè‡ªåŠ¨å¢é‡æ›´æ–°å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†ï¼Œå¤šæ¬¡æ“ä½œæ•ˆæœå¹‚ç­‰ã€‚csearch å¯ä»¥æ”¯æŒç”¨æ­£åˆ™è¡¨è¾¾å¼åœ¨ cindex å·²ç»å»ºç«‹å¥½çš„ç´¢å¼•ä¸Šæ£€ç´¢ä»£ç ã€‚cgrep åˆ™æ˜¯æä¾› grep ç±»ä¼¼äº¤äº’é£æ ¼çš„ csearchã€‚

### 5.1.5 å°ç»“

æ€»ç»“ä¸€ä¸‹ï¼Œ Google Code Search é¡¹ç›®å¹¶ä¸å…³æ³¨ä»“åº“åŒæ­¥ä¸ç´¢å¼•ç»´æŠ¤çš„è‡ªåŠ¨åŒ–ã€‚å¼€å‘è€…å¦‚æœæƒ³å°†å®ƒæœåŠ¡åŒ–ï¼Œéœ€è¦è‡ªå·±æ„å»ºç›¸åº”çš„é€»è¾‘ã€‚ç½‘ä¸Šå¹¶æ²¡æœ‰å…³äº Google å°†å…¶æœåŠ¡åŒ–ã€è§„æ¨¡åŒ–çš„ç»†èŠ‚ã€‚

## 5.2 Hound

ä¸¤ä½åœ¨ [Etsy](https://www.etsy.com/) å·¥ä½œçš„å·¥ç¨‹å¸ˆï¼Œ[Kelly Norton](https://github.com/kellegous) å’Œ [Jonathan Klein](https://github.com/jklein)ï¼ŒåŸºäº Google Code Search æ­å»ºäº† Hound æ¥è§£å†³ä»–ä»¬åœ¨å…¬å¸å†…éƒ¨é‡åˆ°çš„ä»£ç æœç´¢éœ€æ±‚ã€‚

> We've used many similar tools in the past, and most of them are either too slow, too hard to configure, or require too much software to be installed. Which brings us to... â€” Hound README.md

 Hound é¡¹ç›®å°±æ˜¯ Google Code Search é¡¹ç›®çš„æœåŠ¡åŒ–ï¼Œå®ƒç”šè‡³å¾ˆå®åœ¨åœ°åœ¨æºç ä¸­[ç›´æ¥æ¬è¿](https://github.com/hound-search/hound/tree/main/codesearch)äº† google/codesearch çš„ä»“åº“ã€‚å®ƒåœ¨åŸä½œçš„åŸºç¡€ä¸Šå¢åŠ äº†ä»“åº“åŒæ­¥ã€ç´¢å¼•ç»´æŠ¤ã€ HTTP æœåŠ¡ç­‰æ¨¡å—ã€‚

Hound åœ¨å¯åŠ¨æ—¶éœ€è¦è¯»å–ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæè¿°æ•°æ®å­˜æ”¾çš„æ ¹ç›®å½•ï¼Œä»¥åŠéœ€è¦æœç´¢å“ªäº›ä»“åº“ã€‚ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š

```json
{
  "dbpath" : "db",
  "repos" : {
    "Hound" : {
      "url" : "https://github.com/etsy/hound.git"
    }
  }
}
```

å› æ­¤å¦‚æœä½ å¸Œæœ›å®ƒèƒ½å¤Ÿè‡ªåŠ¨å‘ç°æ–°çš„ç¬¦åˆè¦æ±‚çš„ä»“åº“ï¼Œåˆ™éœ€è¦é¢å¤–æä¾›ã€Œä»“åº“å‘ç°ã€é€»è¾‘ã€‚

### 5.2.1 å­˜å‚¨

 Hound çš„æ‰€æœ‰æ•°æ®å­˜æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­åˆ¶å®šçš„ `dbpath` ç›®å½•ä¸‹ã€‚è¯¥ç›®å½•ä¸‹å­˜æ”¾ä¸¤ç§æ–‡ä»¶å¤¹ï¼š

* ä»“åº“æ–‡ä»¶å¤¹ï¼š`vcs-${Repo.Url}`
* ç´¢å¼•æ–‡ä»¶å¤¹ï¼š`idx-${random_hash}`

æ¯ä¸ªä»“åº“ä¸­å­˜æ”¾ç€ `git clone` ä¸‹æ¥çš„æ•°æ®ï¼›ç´¢å¼•æ–‡ä»¶å¤¹çš„å¸ƒå±€å¦‚ä¸‹ï¼š

```sh
idx-10837b48f746028d
â”œâ”€â”€ excluded_files.json
â”œâ”€â”€ metadata.gob
â”œâ”€â”€ raw
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â””â”€â”€ ...
â”‚Â Â   Â Â  
â””â”€â”€ tri
```

å…¶ä¸­ tri æ–‡ä»¶å°±æ˜¯ Google Code Search ä¸­ cindex ç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶ï¼Œè€Œ raw æ–‡ä»¶å¤¹ä¸‹å†—ä½™äº†ä¸€ä»½ä»“åº“ä¸­æ‰€æœ‰è¢«å»ºç«‹ç´¢å¼•çš„æºç æ–‡ä»¶ã€‚

### 5.2.2 æœåŠ¡åŒ–

 Hound çš„å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="./hound-logic-flow.png" width="680px" />

 Hound åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œå¯åŠ¨åå®ƒä¼šå…ˆè§¦å‘é¦–æ¬¡åŒæ­¥ï¼ŒåŒæ—¶æ„å»ºç´¢å¼•ã€‚ä¸è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œä¸€æ—¦æ‰€æœ‰ä»“åº“éƒ½è¢«è®¿é—®ä¸€æ¬¡åï¼Œå°±é€šè¿‡ HTTP æœåŠ¡å¼€æ”¾æœç´¢ APIï¼Œä¹‹åæ¯éš” 30 ç§’ï¼Œ Hound å°±ä¼šå¯åŠ¨ä¸€æ¬¡æ•°æ®çš„å…¨é‡æ›´æ–°ã€‚å¯¹äºå°‘é‡ä»“åº“çš„åœºæ™¯ï¼Œè¿™ä¸ªç­–ç•¥è¿è¡Œå¾—å¾ˆå®Œç¾ã€‚

## 5.3 Livegrep

[Livegrep](https://github.com/livegrep/livegrep/) é¡¹ç›®çš„ README è¿™ä¹ˆä»‹ç»è‡ªå·±ï¼š

> Livegrep is a tool, partially inspired by Google Code Search, for interactive regex search of ~gigabyte-scale source repositories.

å¯ä»¥çœ‹å‡ºï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åœ¨è¶…å¤§å‹é¡¹ç›®ä¸Šå®ç°å®æ—¶æœç´¢ï¼Œè€Œéæˆ‘ä»¬æ‰€é¢ä¸´çš„ã€Œå¾®ä»“åº“ã€åœºæ™¯ã€‚

### 5.3.1 æŸ¥è¯¢è¯­è¨€

Livegrep æ”¯æŒã€Œä¿®é¥°å™¨ã€+ã€ŒåŒ¹é…å™¨ã€æ„æˆçš„æŸ¥è¯¢è¯­å¥ï¼Œå…¶ä¸­ã€ŒåŒ¹é…å™¨ã€å…¼å®¹ RE2 çš„æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•ã€‚å…¶æœç´¢ä¸»é¡µæä¾›äº†ä¸€äº›è¯´æ˜ï¼š

![](./live-grep-home-page.png)

### 5.3.2 ç´¢å¼•

Livegrep ä½¿ç”¨ Suffix Array ç»™ä»“åº“å»ºç«‹ç´¢å¼•ï¼Œå®ƒçš„ä½œè€… Nelson Elhage åœ¨åšå®¢ [Regular Expression Search with Suffix Arrays](https://blog.nelhage.com/2015/02/regular-expression-search-with-suffix-arrays/) ä¸­è¯´é“ï¼Œåœ¨å®è·µä¸­ Livegrep éœ€è¦ä½¿ç”¨åŸä»“åº“è¯­æ–™ 3-5 å€çš„ç©ºé—´å»ºç«‹ç´¢å¼•ï¼Œæ˜¯å…¸å‹çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ã€‚è¿™ä¹Ÿè¯´æ˜è·å¾—å®ƒæä¾›çš„ [æè‡´æœç´¢ä½“éªŒ](https://livegrep.com/search/linux) éœ€è¦ä»˜å‡ºä»£ä»·ã€‚

### 5.3.3 å­˜å‚¨

Livegrep ä¸ºä¸€ä¸ªä»“åº“å»ºç«‹ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œæ„å»ºå®Œæ¯•åå¯ä»¥æŠ›å¼€ä»“åº“ç‹¬ç«‹è¿è¡Œã€‚æ ¹æ®èƒ½å¤Ÿè·å–åˆ°çš„ä¿¡æ¯ï¼Œ Livegrep ä¸»è¦å…³æ³¨å•ä¸ªä»“åº“æœç´¢ï¼Œä¸ºäº†é€Ÿåº¦ï¼Œå®ƒä¼šé»˜è®¤å°†æ•´ä¸ªç´¢å¼•æ–‡ä»¶åŠ è½½è¿›å†…å­˜ï¼Œå¦‚æœå†…å­˜æ”¾ä¸ä¸‹å¯ä»¥ä½¿ç”¨ mmap é€‰é¡¹ã€‚ç”±äºç´¢å¼•ä½“ç§¯è¾ƒå¤§ï¼ŒåŒæ—¶åœ¨æˆç™¾ä¸Šåƒä¸ªä»“åº“ä¸­æœç´¢å¹¶é Livegrep æ‰€æ“…é•¿çš„äº‹æƒ…ã€‚

### 5.3.4 æœåŠ¡åŒ–

Livegrep çš„æ¶æ„ä¸ä»£ç æœç´¢å¼•æ“çš„ä¸€èˆ¬æ¶æ„åŸºæœ¬ä¸€è‡´ï¼Œä¸€ä¸ªè¿›ç¨‹ç”¨äºæ‹‰å–ä»£ç ã€å»ºç«‹ç´¢å¼•ã€æä¾›æŸ¥è¯¢ APIï¼Œä¸€ä¸ªè¿›ç¨‹æä¾›æœç´¢é¡µé¢å’Œ API æœåŠ¡ã€‚æ®å…¶æ–‡æ¡£æ‰€è¿°ï¼Œè¦æ”¯æŒä»“åº“çš„å˜æ›´åŒæ­¥ï¼Œéœ€è¦å¯åŠ¨é¢å¤–çš„è¿›ç¨‹ï¼Œå¦‚ã€Œlivegrep-github-reindexã€ã€‚

## 5.4 Zoekt

> âš ï¸ æœ¬èŠ‚å¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäº Zoekt é¡¹ç›®çš„[è®¾è®¡æ–‡æ¡£](https://github.com/google/zoekt/blob/master/doc/design.md)ã€‚

Google çš„å·¥ç¨‹å¸ˆ Han-Wen åœ¨ 2016 å¹´é¦–æ¬¡å‘å¸ƒäº† Zoekt é¡¹ç›®ï¼Œå¹¶åœ¨ Gerrit Summit 2016 çš„æ¼”è®²ã€Œ[Zoekt - Codesearch for Git](https://storage.googleapis.com/gerrit-talks/summit/2016/zoekt.pdf)ã€ä¸­ä»‹ç»äº†è¿™ä¸ªé¡¹ç›®ã€‚åœ¨æ¥ä¸‹å»çš„ä¸€å¹´ä¸­ï¼Œä»–ç»§ç»­ä¼˜åŒ– Zoekt é¡¹ç›®ï¼Œå¹¶åœ¨ Gerrit Summit 2017 çš„æ¼”è®² ã€Œ[Zoekt, improved - Codesearch, one year later](https://storage.googleapis.com/gerrit-talks/summit/2017/Zoekt%20-%20improved%20codesearch.pdf)ã€ä¸­ä»‹ç»äº†ä»–è§£å†³çš„é—®é¢˜å’Œæ”¹è¿›çš„åŠŸèƒ½ã€‚

### 5.4.1 æŸ¥è¯¢è¯­å¥

Zoekt æ”¯æŒã€Œä¿®é¥°å™¨ã€+ã€ŒåŒ¹é…å™¨ã€æ„æˆçš„æŸ¥è¯¢è¯­å¥ï¼Œå…¶æœç´¢ä¸»é¡µæä¾›äº†è®¸å¤šæŸ¥è¯¢ç¤ºä¾‹å’Œè¯´æ˜ï¼Œä»¥ä¸‹æ˜¯æˆªå›¾ï¼š

![](./zoekt-search-home-page.png)

### 5.4.2 ç´¢å¼•å’Œå­˜å‚¨

Zoekt å°†æ¯ä¸ªä»“åº“çš„æ‰€æœ‰æºç æ–‡ä»¶è¿æ¥æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶åŸºäºå®ƒæ„å»º Positional Trigram ç´¢å¼•ï¼Œå¹¶å°†ç´¢å¼•æ•°æ®ç”¨ gob ç¼–ç åç›´æ¥é™„åŠ åœ¨å¤§æ–‡ä»¶åé¢ï¼š

![](./zoekt-index.png)

è¿™ä¸ªæ–‡ä»¶çš„åç¼€åä¸º `${repo}.zoekt`ã€‚ç”±äº `.zoekt` æ–‡ä»¶åŒæ—¶åŒ…å«ä»£ç å’Œç´¢å¼•ï¼Œåªè¦æ²¡æœ‰æ–°çš„ä»£ç æ›´æ–°ï¼ŒZoekt å¯ä»¥åªé ç´¢å¼•æ–‡ä»¶æ¥æä¾›æœç´¢æœåŠ¡ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒZoekt è¿˜æ”¯æŒé€šè¿‡å¼•å…¥ ctags ä¼˜åŒ–æŸ¥è¯¢ç»“æ„çš„æ’åºã€‚

### 5.4.3 æœåŠ¡åŒ–

Zoekt éƒ¨ç½²åŒ…å«ä¸¤ä¸ªæ¨¡å—ï¼šzoekt-indexserver å’Œ zoekt-webserverã€‚å®ƒçš„æ¶æ„ä¸ä»£ç æœç´¢å¼•æ“çš„ä¸€èˆ¬æ¶æ„åŸºæœ¬ä¸€è‡´ã€‚zoekt-indexserver è´Ÿè´£ä»£ç åŒæ­¥å’Œç´¢å¼•ç»´æŠ¤ï¼Œå®ƒåŸç”Ÿç»§æ‰¿äº†è®¸å¤šä»£ç æ‰˜ç®¡æœåŠ¡ï¼Œå¦‚ Githubã€Gitlabã€Bitbucketã€Gerrit å’Œ Gitilesï¼ŒåŒæ—¶è¿˜æ”¯æŒé…ç½®ä»“åº“è¿‡æ»¤å™¨ï¼Œé€šè¿‡ä»“åº“åç§°ç­‰ç‰¹å¾æ¥é€‰æ‹©æ”¯æŒçš„æœç´¢èŒƒå›´ï¼Œè§£å†³äº†ä»“åº“å‘ç°çš„é—®é¢˜ï¼Œè¿™æ–¹é¢æ¯” Hound è¦å‹å¥½å¾ˆå¤šã€‚é»˜è®¤é…ç½®ä¸‹ï¼Œzoekt-indexserver æ¯å¤©æ‹‰å–ä¸€æ¬¡ä»“åº“æ•°æ®ï¼Œé‡å»ºç´¢å¼•ã€‚zoekt-webserver åˆ™è´Ÿè´£æä¾› HTTP æœåŠ¡å’Œæœç´¢é¡µé¢ã€‚

## 5.5 Sourcegraph

å®é™…ä¸Š Sourcegraph æ˜¯ä¸€å®¶[å…¬å¸](https://www.crunchbase.com/organization/sourcegraph/technology)çš„åå­—ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å®ƒä»¬çš„æ ¸å¿ƒä»£ç æœç´¢[äº§å“](https://github.com/sourcegraph/sourcegraph)çš„åç§°ã€‚åŸºäºå…¶å¤§è§„æ¨¡ä»£ç æ£€ç´¢èƒ½åŠ›ï¼ŒSourcegraph è¿˜å‘å¸ƒäº†å¤šä¸ªäº§å“ï¼š

* Code Searchï¼šæä¾›æµ·é‡ä»“åº“æœç´¢åŠŸèƒ½
* Code Intelligenceï¼šæä¾›è·¨ä»“åº“çš„ç±»ä¼¼ IDE çš„ä¸°å¯Œçš„äº‘ä¸Šä»£ç è®¿é—®ã€è·³è½¬åŠŸèƒ½
* Batch Changesï¼šè·¨ä»“åº“æ‰¹é‡ä¿®æ”¹ä»£ç ï¼Œæ¨é€ PR/MR å¹¶è·Ÿè¸ªåˆå¹¶ç»“æœ

æœ¬èŠ‚æˆ‘ä»¬ä¸»è¦å…³æ³¨å®ƒçš„ Code Search äº§å“ï¼Œä¸‹æ–‡ä¸­å¦‚æ— ç‰¹æ®Šè¯´æ˜ï¼Œæˆ‘ä»¬ç”¨ Sourcegraph æŒ‡ä»£å…¶ Code Search äº§å“ã€‚

### 5.5.1 æŸ¥è¯¢è¯­è¨€

Sourcegraph æ”¯æŒã€Œè®¾è®¡å†³å®šã€ä¸€èŠ‚ä¸­æåˆ°çš„æ‰€æœ‰æŸ¥è¯¢è¯­è¨€ï¼Œä¹Ÿæ˜¯å½“å‰å”¯ä¸€æ”¯æŒç»“æ„åŒ–æŸ¥è¯¢çš„ä»£ç æœç´¢å¼•æ“ã€‚æƒ³äº†è§£å®ƒæ”¯æŒçš„å®Œæ•´è¯­æ³•å’Œä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥ç¿»é˜…å®ƒçš„[å®˜æ–¹æ–‡æ¡£](https://docs.sourcegraph.com/code_search)ã€‚å¦‚æœä½ å¯¹ Sourcegraph å¦‚ä½•æ”¯æŒç»“æ„åŒ–æŸ¥è¯¢æœ‰ä¸ªå¤§è‡´äº†è§£ï¼Œå¯ä»¥çœ‹çœ‹å®ƒä»¬çš„è®¾è®¡æ–‡æ¡£ [RFC 40](https://docs.google.com/document/d/16WwZA8zf-soI0HgCXGrRL5IrmyZnGYrB5VTXsqguUzo/edit#)ï¼ŒåŒæ—¶ä¹Ÿè®¸ä½ ä¼šå¯¹ [comby](https://github.com/comby-tools/comby) æ„Ÿå…´è¶£ã€‚

### 5.5.2 ç´¢å¼•

Sourcegraph å®é™…åˆ©ç”¨ Zoekt é©±åŠ¨ï¼Œå› æ­¤å®ƒä½¿ç”¨çš„è‡ªç„¶ä¹Ÿæ˜¯ Positional Trigram ç´¢å¼•ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒSourcegraph å…¬å¸çš„ Code Intelligence äº§å“è¿˜æœ‰ä¸€ä¸ª Precise Code Intelligence ç‰ˆæœ¬ï¼Œæ˜¯ç”± LSIF ç´¢å¼•é©±åŠ¨ã€‚

### 5.5.3 å­˜å‚¨

Sourcegraph åœ¨éš”ç¦»ä»£ç å’Œç´¢å¼•ä¸Šæ›´è¿‘äº†ä¸€æ­¥ã€‚åœ¨å®ƒçš„æ¶æ„ä¸­å­˜åœ¨ä¸€ä¸ªæ”¯æŒæ¨ªå‘æ‰©å±•çš„ gitserver æœåŠ¡ï¼Œè´Ÿè´£ä»ä¸åŒçš„ä»£ç æ‰˜ç®¡æœåŠ¡ä¸­æ‹‰å–æ•°æ®ã€‚è€Œç”± zoekt-indexserver è´Ÿè´£å¯¹ gitserver ä¸­çš„ä»“åº“æ„å»º Positional Trigram ç´¢å¼•ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œè¿˜æœ‰ä¸€ä¸ªå«åš repo-updater çš„ç»„ä»¶è´Ÿè´£ gitserver æ•°æ®æ‹‰å–ä»»åŠ¡çš„è°ƒåº¦ï¼Œåè€…å°†å…ƒæ•°æ®å­˜å‚¨åœ¨ Postgres ä¸­ï¼ŒåŒæ—¶å‘ gitserver å‘é€ç›¸å…³å‘½ä»¤ã€‚

ç”±äº Sourcegraph éœ€è¦æ”¯æŒä¸ºæµ·é‡ä»“åº“å»ºç«‹ç´¢å¼•ï¼Œå®ƒè¿˜åŸºäºä»“åº“æ´»è·ƒåº¦åˆ¶å®šäº†æ•°æ®åŒæ­¥çš„é€€é¿ (backoff) ç­–ç•¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼šå¦‚æœä¸€ä¸ªä»“åº“çš„æœ€åä¸€ä¸ª commit åœ¨ 8 å°æ—¶ä»¥å‰ï¼Œä¸‹ä¸€æ¬¡æ•°æ®åŒæ­¥å°±ä¼šåœ¨ 4 å°æ—¶ (8 å°æ—¶çš„ 1/2) åè°ƒåº¦ï¼Œå¦‚æœå±Šæ—¶ä»ç„¶æ²¡æœ‰æ•°æ®å˜åŠ¨ï¼Œåˆ™å†ä¸‹ä¸€æ¬¡æ•°æ®åŒæ­¥ä»»åŠ¡å°†åœ¨ 6 å°æ—¶å€™è¢«è°ƒåº¦ã€‚

### 5.5.4 æœåŠ¡åŒ–

> âš ï¸ æœ¬èŠ‚å†…å®¹æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£ [Sourcegraph architecture overview](https://docs.sourcegraph.com/dev/background-information/architecture)ã€‚

ä»¥ä¸‹æ˜¯ Sourcegraph çš„æ¶æ„å…¨å›¾ï¼š

![](./sourcegraph-architecture.png)

ä»£ç åŒæ­¥ç”± gitserver å’Œ repo-updater å®Œæˆï¼Œè¯¦æƒ…å¯æŸ¥çœ‹ [Life of a repository](https://docs.sourcegraph.com/dev/background-information/architecture/life-of-a-repository)ï¼›åŸºäºæ–‡æœ¬çš„ä»£ç æœç´¢ç”± Zoekt é¡¹ç›®æ”¯æŒï¼ŒåŒ…æ‹¬ zoekt-indexserver å’Œ zoekt-webserverã€‚åœ¨æœªå»ºç«‹ç´¢å¼•çš„åˆ†æ”¯ä¸Šçš„æŸ¥è¯¢ç”± searcher å®Œæˆã€‚syntect-server è´Ÿè´£å¾€æœç´¢ç»“æœä¸­æ·»åŠ è¯­æ³•é«˜äº®ä¿¡æ¯ï¼Œè¯¦æƒ…å¯æŸ¥çœ‹ [Life of a search query](https://docs.sourcegraph.com/dev/background-information/architecture/life-of-a-search-query)ï¼›precise-code-intel-worker åˆ™è´Ÿè´£å‰é¢æåˆ°çš„ Precise Code Intelligenceã€‚

ä½œä¸ºä¸€ä¸ªå•†ä¸šåŒ–çš„ä»£ç æœç´¢å¼•æ“é¡¹ç›®ï¼ŒSourcegraph æ— è®ºåœ¨ç³»ç»Ÿè®¾è®¡ä¸Šè¿˜æ˜¯äº§å“ä½“éªŒä¸Šéƒ½æ›´åŠ å®Œå–„ã€‚

## 5.6 é¡¹ç›®å¯¹æ¯”

| é¡¹ç›®åç§°               | æŸ¥è¯¢è¯­è¨€                                     | ç´¢å¼•                            | æœåŠ¡æ¶æ„                     |
| ---------------------- | -------------------------------------------- | ------------------------------- | ---------------------------- |
| **Google Code Search** | [substring, regexp]                          | Trigram                         | -                            |
| **Hound**              | [substring, regexp]                          | Trigram                         | WebServerã€ IndexServer åˆå¹¶ |
| **Livegrep**           | [substring, regexp] + [modifier]             | Suffix Array                    | WebServerã€IndexServer éš”ç¦»  |
| **Zoekt**              | [substring, regexp] + [modifier]             | Positional Trigram, Ctags       | WebServerã€IndexServer éš”ç¦»  |
| **Sourcegraph**        | [substring, regexp, structural] + [modifier] | Positional Trigram, Ctags, LSIF | WebServerã€IndexServer éš”ç¦»  |

# 6. å‚è€ƒæ–‡çŒ®

- Code Search
  - [google/codesearch](https://github.com/google/codesearch)
  - [Regular Expression Matching with a Trigram Index or How Google Code Search Worked](https://swtch.com/~rsc/regexp/regexp4.html)
  - [aaw/regrams](https://github.com/aaw/regrams), [Regular Expression Search via Graph Cuts](http://blog.aaw.io/2016/06/10/regrams-intro.html)
- Hound
  - [hound-search/hound](https://github.com/hound-search/hound)
- Zoekt
  - [google/zoekt](https://github.com/google/zoekt), [design doc](https://github.com/google/zoekt/blob/master/doc/design.md)
  - Gerrit Summit 2016: [Zoekt â€” Code search for Git](https://storage.googleapis.com/gerrit-talks/summit/2016/zoekt.pdf)
  - Gerrit Summit 2017: [Zoekt, improved â€” Code search, one year later](https://storage.googleapis.com/gerrit-talks/summit/2017/Zoekt - improved codesearch.pdf)
- Sourcegraph
  - [sourcegraph/sourcegraph](http://github.com/sourcegraph/sourcegraph)
  - [Going beyond regular expressions with structural code search](https://about.sourcegraph.com/blog/going-beyond-regular-expressions-with-structural-code-search/?_ga=2.47533863.1028188413.1619672448-1802763594.1619435671)
  - [comby-tools/comby](https://github.com/comby-tools/comby)
  - [RFC 48 APPROVED: Structural Search](https://docs.google.com/document/d/16WwZA8zf-soI0HgCXGrRL5IrmyZnGYrB5VTXsqguUzo/edit#)
  - Documentation
    - [Sourcegraph architecture overview](https://docs.sourcegraph.com/dev/background-information/architecture)
    - [Search-based code intelligence](https://docs.sourcegraph.com/code_intelligence/explanations/search_based_code_intelligence)
    - [Precise code intelligence](https://docs.sourcegraph.com/code_intelligence/explanations/precise_code_intelligence)
    - [Life of a repository](https://docs.sourcegraph.com/dev/background-information/architecture/life-of-a-repository)
    - [Life of a search query](https://docs.sourcegraph.com/dev/background-information/architecture/life-of-a-search-query)
    - [Search pagination](https://docs.sourcegraph.com/dev/background-information/architecture/search-pagination)
- Livegrep
  - [livegrep/livegrep](https://github.com/livegrep/livegrep/)
  - [Regular Expression Search with Suffix Arrays](https://blog.nelhage.com/2015/02/regular-expression-search-with-suffix-arrays/)
- Code Intelligence
  - [Universal Ctags](https://ctags.io/)
  - [Language Server Protocol](https://microsoft.github.io/language-server-protocol/)
  - [GopherCon 2019 Lightning Talk: Chris Wendt - LSIF + Go](https://www.youtube.com/watch?v=fMIRKRj_A88)
- Regular Expressions
  - [Implementing Regular Expressions](https://swtch.com/~rsc/regexp/)
  - [Regular Expression Matching Can Be Simple And Fast](https://swtch.com/~rsc/regexp/regexp1.html)
  - [Regular Expression Matching: the Virtual Machine Approach](https://swtch.com/~rsc/regexp/regexp2.html)
  - [Regular Expression Matching in the Wild](https://swtch.com/~rsc/regexp/regexp3.html)
- Misc
  - [How Developers Search for Code: A Case Study](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/43835.pdf)