<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhenghe-md.github.io","root":"/blog/","scheme":"Pisces","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æœ€è¿‘åœ¨é˜…è¯» TiDB æºç  util&#x2F;chunk package çš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°äº† Apache Arrow è¿™ä¸ªé¡¹ç›® (ä¸‹æ–‡ç®€ç§° Arrow)ï¼š 12345&#x2F;&#x2F; Chunk stores multiple rows of data in Apache Arrow format.&#x2F;&#x2F; See https:&#x2F;&#x2F;arrow.apache.org&#x2F;docs&#x2F;format&#x2F;Columnar.html#ph">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Arrow å°ç»“">
<meta property="og:url" content="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/index.html">
<meta property="og:site_name" content="ZhengHe">
<meta property="og:description" content="æœ€è¿‘åœ¨é˜…è¯» TiDB æºç  util&#x2F;chunk package çš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°äº† Apache Arrow è¿™ä¸ªé¡¹ç›® (ä¸‹æ–‡ç®€ç§° Arrow)ï¼š 12345&#x2F;&#x2F; Chunk stores multiple rows of data in Apache Arrow format.&#x2F;&#x2F; See https:&#x2F;&#x2F;arrow.apache.org&#x2F;docs&#x2F;format&#x2F;Columnar.html#ph">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/defragmenting-data.jpg">
<meta property="og:image" content="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/row-col.jpg">
<meta property="og:image" content="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/experiment-1.png">
<meta property="og:image" content="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/experiment-2.png">
<meta property="article:published_time" content="2020-09-20T21:14:48.000Z">
<meta property="article:modified_time" content="2020-12-08T10:02:35.145Z">
<meta property="article:author" content="ZhengHe">
<meta property="article:tag" content="database">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/defragmenting-data.jpg">

<link rel="canonical" href="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Apache Arrow å°ç»“ | ZhengHe</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172943223-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-172943223-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container {
  overflow: auto hidden;
}

mjx-container + br {
  display: none;
}
</style><link rel="alternate" href="/blog/atom.xml" title="ZhengHe" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZhengHe</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-fw fa-user"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>å½’æ¡£</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.jpeg">
      <meta itemprop="name" content="ZhengHe">
      <meta itemprop="description" content="éƒ‘é¹¤çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZhengHe">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Apache Arrow å°ç»“
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-09-20 21:14:48" itemprop="dateCreated datePublished" datetime="2020-09-20T21:14:48+00:00">2020-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-08 10:02:35" itemprop="dateModified" datetime="2020-12-08T10:02:35+00:00">2020-12-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/system-design/" itemprop="url" rel="index">
                    <span itemprop="name">system design</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/2020/09/20/apache-arrow-summary/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/20/apache-arrow-summary/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>æœ€è¿‘åœ¨é˜…è¯» TiDB æºç  util/chunk package çš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°äº† Apache Arrow è¿™ä¸ªé¡¹ç›® (ä¸‹æ–‡ç®€ç§° Arrow)ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Chunk stores multiple rows of data in Apache Arrow format.</span></span><br><span class="line"><span class="comment">// See https://arrow.apache.org/docs/format/Columnar.html#physical-memory-layout</span></span><br><span class="line"><span class="comment">// Values are appended in compact format and can be directly accessed without decoding.</span></span><br><span class="line"><span class="comment">// When the chunk is done processing, we can reuse the allocated memory by resetting it.</span></span><br><span class="line"><span class="keyword">type</span> Chunk <span class="keyword">struct</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br></pre></td></tr></table></figure>
<p>å¿ƒé‡Œè‡ªç„¶è€Œç„¶ä¼šäº§ç”Ÿç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªé¡¹ç›®è§„å®šçš„æ•°æ®å­˜å‚¨æ ¼å¼ï¼Ÿäºæ˜¯åœ¨é˜…è¯»å®Œ TiDB ç›¸å…³æºç å’Œå•æµ‹åï¼Œé¡ºä¾¿æœå¯»å¹¶æµè§ˆä¸€äº›æœ‰è¶£çš„èµ„æ–™ (è§æ–‡æœ«å‚è€ƒéƒ¨åˆ†)ï¼Œç°åœ¨å°†è¿™æ¬¡è°ƒç ”çš„æ”¶è·å°ç»“åœ¨è¿™ç¯‡åšå®¢ä¸­ã€‚</p>
<h2 id="é¡¹ç›®ç®€ä»‹">é¡¹ç›®ç®€ä»‹</h2>
<p>ç°å­˜çš„å¤§æ•°æ®åˆ†æç³»ç»ŸåŸºæœ¬éƒ½åŸºäºå„è‡ªä¸åŒçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œè¿™å°±ä¼šå¸¦æ¥ä¸€ç³»åˆ—çš„é‡å¤å·¥ä½œï¼šä»è®¡ç®—å¼•æ“ä¸Šçœ‹ï¼Œç®—æ³•å¿…é¡»åŸºäºé¡¹ç›®ç‰¹æœ‰çš„æ•°æ®ç»“æ„ã€API ä¸ç®—æ³•ä¹‹é—´å‡ºç°ä¸å¿…è¦çš„è€¦åˆï¼›ä»æ•°æ®è·å–ä¸Šçœ‹ï¼Œæ•°æ®åŠ è½½æ—¶å¿…é¡»ååºåˆ—åŒ–ï¼Œè€Œæ¯ä¸€ç§æ•°æ®æºéƒ½éœ€è¦å•ç‹¬å®ç°ç›¸åº”çš„åŠ è½½å™¨ï¼›ä»ç”Ÿæ€ç³»ç»Ÿä¸Šçœ‹ï¼Œè·¨é¡¹ç›®ã€è·¨è¯­è¨€çš„åˆä½œæ— å½¢ä¹‹ä¸­è¢«é˜»éš”ã€‚èƒ½å¦å‡å°‘æˆ–æ¶ˆé™¤æ•°æ®åœ¨ä¸åŒç³»ç»Ÿé—´åºåˆ—åŒ–ã€ååºåˆ—åŒ–çš„æˆæœ¬ï¼Ÿèƒ½å¦è·¨é¡¹ç›®å¤ç”¨ç®—æ³•åŠ IO å·¥å…·ï¼Ÿèƒ½å¦æ¨åŠ¨æ›´å¹¿ä¹‰çš„åˆä½œï¼Œè®©æ•°æ®åˆ†æç³»ç»Ÿçš„å¼€å‘è€…è”åˆèµ·æ¥ï¼Ÿåœ¨è¿™æ ·çš„ä½¿å‘½é©±åŠ¨ä¸‹ï¼ŒArrow å°±è¯ç”Ÿäº†ã€‚</p>
<p>ä¸å…¶å®ƒé¡¹ç›®ä¸åŒï¼ŒArrow é¡¹ç›®çš„è‰å°ç­å­ç”± 5 ä¸ª Apache Membersã€6 ä¸ª PMC Chairs å’Œä¸€äº›å…¶å®ƒé¡¹ç›®çš„ PMC åŠ committer æ„æˆï¼Œä»–ä»¬ç›´æ¥æ‰¾åˆ° ASF è‘£äº‹ä¼šï¼Œå¾å¾—åŒæ„åç›´æ¥ä»¥é¡¶çº§ Apache é¡¹ç›®èº«ä»½å¯åŠ¨ã€‚æƒ³äº†è§£é¡¹ç›®çš„è¯¦ç»†å†å²å¯ä»¥é˜…è¯»é¡¹ç›® Chairï¼ŒJacques Nadeau å†™çš„è¿™ç¯‡<a href="https://www.dremio.com/origin-history-of-apache-arrow/" target="_blank" rel="noopener">åšå®¢</a>ã€‚å¦å¤–ï¼Œè¿™å¼  <a href="https://docs.google.com/spreadsheets/d/1q6UqluW6SLuMKRwW2TBGBzHfYLlXYm37eKJlIxWQGQM/edit#gid=0" target="_blank" rel="noopener">google sheet</a> è®°å½•ç€é¡¹ç›®çš„å–åè¿‡ç¨‹ï¼Œå–åä¸º Arrow çš„åŸå› æ˜¯ï¼š"math symbol for vector. and arrows are fast. also alphabetically will show up on top." å¯ä»¥è¯´è€ƒè™‘å¾—ç›¸å½“å…¨é¢ ğŸ˜‚ã€‚</p>
<p>Arrow çš„æ„¿æ™¯æ˜¯æä¾›å†…å­˜æ•°æ®åˆ†æ (in-memory analytics) çš„å¼€å‘å¹³å°ï¼Œè®©æ•°æ®åœ¨å¼‚æ„å¤§æ•°æ®ç³»ç»Ÿé—´ç§»åŠ¨ã€å¤„ç†åœ°æ›´å¿«ï¼š</p>
<p><img src="/blog/2020/09/20/apache-arrow-summary/defragmenting-data.jpg" /></p>
<p>é¡¹ç›®ä¸»è¦ç”± 3 éƒ¨åˆ†æ„æˆï¼š</p>
<ul>
<li>ä¸ºåˆ†ææŸ¥è¯¢å¼•æ“ (analytical query engines)ã€æ•°æ®å¸§ (data frames) è®¾è®¡çš„å†…å­˜åˆ—å­˜æ•°æ®æ ¼å¼</li>
<li>ç”¨äº IPC/RPC çš„äºŒè¿›åˆ¶åè®®</li>
<li>ç”¨äºæ„å»ºæ•°æ®å¤„ç†åº”ç”¨çš„å¼€å‘å¹³å°</li>
</ul>
<p>æ•´ä¸ªé¡¹ç›®çš„åŸºçŸ³æ˜¯åŸºäºå†…å­˜çš„åˆ—å­˜æ•°æ®æ ¼å¼ï¼Œç°åœ¨å°†å®ƒçš„ç‰¹ç‚¹ç½—åˆ—å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ ‡å‡†åŒ– (standardized)ï¼Œä¸è¯­è¨€æ— å…³ (language-independent)</li>
<li>åŒæ—¶æ”¯æŒå¹³é“º (flat) å’Œå±‚çº§ (hierarchical) æ•°æ®ç»“æ„</li>
<li>ç¡¬ä»¶æ„ŸçŸ¥ (hardware-aware)</li>
</ul>
<h2 id="åŸºäºå†…å­˜çš„åˆ—å­˜æ ¼å¼">åŸºäºå†…å­˜çš„åˆ—å­˜æ ¼å¼</h2>
<p>è¯¦ç»†ã€å‡†ç¡®çš„æ ¼å¼å®šä¹‰è¯·é˜…è¯»å®˜æ–¹<a href="https://arrow.apache.org/docs/format/Columnar.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ï¼Œæœ¬èŠ‚å†…å®¹å‚è€ƒäº†å®˜æ–¹æ–‡æ¡£åŠ Daniel Abadi çš„è¿™ç¯‡<a href="http://dbmsmusings.blogspot.com/2017/10/apache-arrow-vs-parquet-and-orc-do-we.html" target="_blank" rel="noopener">åšå®¢</a>ã€‚</p>
<p>åœ¨å®è·µä¸­ï¼Œå·¥ç¨‹å¸ˆé€šå¸¸ä¼šå°†ç³»ç»Ÿä¸­çš„æ•°æ®é€šè¿‡å¤šä¸ªäºŒç»´æ•°æ®è¡¨å»ºæ¨¡ï¼Œæ¯å¼ æ•°æ®è¡¨çš„ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªå®ä½“ (entity)ï¼Œä¸€åˆ—è¡¨ç¤ºåŒä¸€å±æ€§ã€‚ç„¶è€Œï¼Œåœ¨ç¡¬ä»¶ä¸­å­˜å‚¨å™¨é€šå¸¸æ˜¯ä¸€ç»´çš„ï¼Œå³è®¡ç®—æœºç¨‹åºåªèƒ½çº¿æ€§åœ°ã€æ²¿åŒä¸€æ–¹å‘åœ°ä»å†…å­˜æˆ–ç¡¬ç›˜ä¸­è¯»å–æ•°æ®ï¼Œå› æ­¤å­˜å‚¨äºŒç»´æ•°æ®è¡¨å°±æœ‰ä¸¤ç§å…¸å‹æ–¹æ¡ˆï¼š<strong>è¡Œå­˜</strong>å’Œ<strong>åˆ—å­˜</strong>ã€‚é€šå¸¸å‰è€…é€‚ç”¨äº OLTP åœºæ™¯ï¼Œåè€…é€‚ç”¨äº OLAP åœºæ™¯ï¼ŒArrow æ˜¯é¢å‘æ•°æ®åˆ†æå¼€å‘çš„ï¼Œå› æ­¤é‡‡ç”¨åè€…ã€‚</p>
<p><img src="/blog/2020/09/20/apache-arrow-summary/row-col.jpg" alt="rowcol" width="600px"/></p>
<p>ä»»ä½•ä¸€å¼ æ•°æ®è¡¨éƒ½å¯èƒ½ç”±ä¸ç±»å‹çš„æ•°æ®åˆ—æ„æˆã€‚ä»¥æŸå¼ ç”¨æˆ·è¡¨ä¸ºä¾‹ï¼Œè¡¨ä¸­å¯èƒ½åŒ…å«å¦‚å¹´é¾„ (integer)ã€å§“å (varchar)ã€å‡ºç”Ÿæ—¥æœŸ (date) ç­‰å±æ€§ã€‚Arrow å°†æ•°æ®è¡¨ä¸­æ‰€æœ‰å¯èƒ½çš„åˆ—æ•°æ®åˆ†æˆä¸¤ç±»ï¼Œå®šé•¿å’Œå˜é•¿ï¼Œå¹¶åŸºäºå®šé•¿å’Œå˜é•¿æ•°æ®ç±»å‹æ„å»ºå‡ºæ›´å¤æ‚çš„åµŒå¥—æ•°æ®ç±»å‹ã€‚</p>
<h3 id="fixed-width-data-types">Fixed-width data types</h3>
<p>å®šé•¿çš„æ•°æ®åˆ—æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FixedColumn <span class="keyword">struct</span> &#123;</span><br><span class="line">  data       []<span class="keyword">byte</span></span><br><span class="line">  length     <span class="keyword">int</span></span><br><span class="line">  nullCount  <span class="keyword">int</span></span><br><span class="line">  nullBitmap []<span class="keyword">byte</span> <span class="comment">// bit 0 is null, 1 is not null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™¤äº†æ•°æ®æ•°ç»„ (data) å¤–ï¼Œè¿˜åŒ…å«ï¼š</p>
<ul>
<li>æ•°ç»„é•¿åº¦ (length)</li>
<li>null å…ƒç´ çš„ä¸ªæ•° (nullCount)</li>
<li>null ä½å›¾ (nullBitmap)</li>
</ul>
<p>ä»¥ Int32 æ•°ç»„ï¼š<code>[1, null, 2, 4, 8]</code> ä¸ºä¾‹ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">length: 5, nullCount: 1</span><br><span class="line">nullBitmap:</span><br><span class="line">|Byte 0 (null bitmap) | Bytes 1-63            |</span><br><span class="line">|---------------------|-----------------------|</span><br><span class="line">| 00011101            | 0 (padding)           |</span><br><span class="line">data:</span><br><span class="line">|Bytes 0-3   | Bytes 4-7   | Bytes 8-11  | Bytes 12-15 | Bytes 16-19 | Bytes 20-63 |</span><br><span class="line">|------------|-------------|-------------|-------------|-------------|-------------|</span><br><span class="line">| 1          | unspecified | 2           | 4           | 8           | unspecified |</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„è®¾è®¡å†³å®šï¼Œæ— è®ºæ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´  (cell) æ˜¯å¦æ˜¯ nullï¼Œåœ¨å®šé•¿æ•°æ®æ ¼å¼ä¸­ Arrow éƒ½ä¼šè®©è¯¥å…ƒç´ å æ®è§„å®šé•¿åº¦çš„ç©ºé—´ï¼›å¦ä¸€ç§å¤‡é€‰æ–¹æ¡ˆå°±æ˜¯ä¸ç»™ null å…ƒç´ åˆ†é…ä»»ä½•ç©ºé—´ã€‚å‰è€…å¯ä»¥åˆ©ç”¨æŒ‡é’ˆä»£æ•°æ”¯æŒ O(1) çš„éšæœºè®¿é—®ï¼Œåè€…åœ¨éšæœºè®¿é—®æ—¶éœ€è¦å…ˆåˆ©ç”¨ nullBitmap è®¡ç®—å‡ºä½ç§»ã€‚å¦‚æœæ˜¯é¡ºåºè®¿é—®ï¼Œåè€…éœ€è¦çš„å†…å­˜å¸¦å®½æ›´å°ï¼Œæ€§èƒ½æ›´ä¼˜ï¼Œå› æ­¤è¿™é‡Œä¸»è¦ä½“ç°çš„æ˜¯å­˜å‚¨ç©ºé—´ä¸éšæœºè®¿é—®æ€§èƒ½çš„æƒè¡¡ï¼ŒArrow é€‰æ‹©å€¾å‘æ˜¯åè€…ã€‚</p>
<p>ä» nullBitmap çš„ç»“æ„å¯ä»¥çœ‹å‡ºï¼ŒArrow é‡‡ç”¨ little-endian å­˜å‚¨å­—èŠ‚æ•°æ®ã€‚</p>
<h3 id="variable-width-data-types">Variable-width data types</h3>
<p>å˜é•¿çš„æ•°æ®åˆ—æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> VarColumn <span class="keyword">struct</span> &#123;</span><br><span class="line">  data       []<span class="keyword">byte</span></span><br><span class="line">  offsets    []<span class="keyword">int64</span></span><br><span class="line">  length     <span class="keyword">int</span></span><br><span class="line">  nullCount  <span class="keyword">int</span></span><br><span class="line">  nullBitmap []<span class="keyword">byte</span> <span class="comment">// bit 0 is null, 1 is not null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œæ¯”å®šé•¿åˆ—ä»…å¤šå­˜ä¸€ä¸ªåç§»é‡æ•°ç»„ (offsets)ã€‚offsets çš„ç¬¬ä¸€ä¸ªå…ƒç´ å›ºå®šä¸º 0ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸ºæ•°æ®çš„é•¿åº¦ï¼Œå³ä¸ length ç›¸ç­‰ï¼Œé‚£ä¹ˆå…³äºç¬¬ i ä¸ªå˜é•¿å…ƒç´ ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pos  := column.offsets[i]                       <span class="comment">// ä½ç½®</span></span><br><span class="line">size := column.offsets[i+<span class="number">1</span>] - column.offsets[i] <span class="comment">// å¤§å°</span></span><br></pre></td></tr></table></figure>
<p>å¦ä¸€ç§å¤‡é€‰æ–¹æ¡ˆæ˜¯åœ¨ data ä¸­åˆ©ç”¨ç‰¹æ®Šçš„å­—ç¬¦åˆ†éš”ä¸åŒå…ƒç´ ï¼Œåœ¨ä¸ªåˆ«æŸ¥è¯¢åœºæ™¯ä¸‹ï¼Œåè€…èƒ½å–å¾—æ›´ä¼˜çš„æ€§èƒ½ã€‚å¦‚æ‰«æå­—ç¬¦ä¸²åˆ—ä¸­åŒ…å«æŸä¸¤ä¸ªè¿ç»­å­—æ¯çš„æ‰€æœ‰åˆ—ï¼šåˆ©ç”¨ Arrow çš„æ ¼å¼éœ€è¦é¢‘ç¹åœ°è®¿é—® offsets æ¥éå† dataï¼Œä½†åˆ©ç”¨ç‰¹æ®Šåˆ†éš”ç¬¦çš„è§£å†³æ–¹æ¡ˆç›´æ¥éå†ä¸€æ¬¡ data å³å¯ã€‚è€Œåœ¨å…¶å®ƒåœºæ™¯ä¸‹ï¼Œå¦‚æŸ¥è¯¢æŸå­—ç¬¦ä¸²åˆ—ä¸­å€¼å’Œ "hello world" ç›¸ç­‰çš„å­—ç¬¦ä¸²ï¼Œè¿™æ—¶åˆ©ç”¨ offsets èƒ½è¿‡æ»¤æ‰æ‰€æœ‰é•¿åº¦ä¸ä¸º 11 çš„åˆ—ï¼Œå› æ­¤åˆ©ç”¨ Arrow çš„æ ¼å¼èƒ½è·å–æ›´ä¼˜çš„æ€§èƒ½ã€‚</p>
<h3 id="nested-data">Nested Data</h3>
<p>æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸€äº›å¤æ‚æ•°æ®ç±»å‹å¦‚ JSONã€structã€union éƒ½å¾ˆå—å¼€å‘è€…æ¬¢è¿ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ•°æ®ç±»å‹å½’ç±»ä¸ºåµŒå¥—æ•°æ®ç±»å‹ã€‚Arrow å¤„ç†åµŒå¥—æ•°æ®ç±»å‹çš„æ–¹å¼å¾ˆä¼˜é›…ï¼Œå¹¶æœªå¼•å…¥å®šé•¿å’Œå˜é•¿æ•°æ®åˆ—ä¹‹å¤–çš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥åˆ©ç”¨äºŒè€…æ¥æ„å»ºã€‚å‡è®¾ä»¥ä¸€æ‰€å¤§å­¦çš„ç­çº§ (Class) ä¿¡æ¯æ•°æ®åˆ—ä¸ºä¾‹ï¼Œè¯¥åˆ—ä¸­æœ‰ä»¥ä¸‹ä¸¤æ¡æ•°æ®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 1</span><br><span class="line">Name:       Introduction to Database Systems</span><br><span class="line">Instructor: Daniel Abadi</span><br><span class="line">Students:   Alice, Bob, Charlie</span><br><span class="line">Year:       2019</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 2</span><br><span class="line">Name:       Advanced Topics in Database Systems</span><br><span class="line">Instructor: Daniel Abadi</span><br><span class="line">Students:   Andrew, Beatrice</span><br><span class="line">Year:       2020</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å°†æ”¹åµŒå¥—æ•°æ®ç»“æ„åˆ†æˆ 4 åˆ—ï¼šNameã€Instructorã€Students ä»¥åŠ Yearï¼Œå…¶ä¸­ Name å’Œ Instructor æ˜¯å˜é•¿å­—ç¬¦ä¸²åˆ—ï¼ŒYear æ˜¯å®šé•¿æ•´æ•°åˆ—ï¼ŒStudents æ˜¯å­—ç¬¦ä¸²æ•°ç»„åˆ— (äºŒç»´æ•°ç»„)ï¼Œå®ƒä»¬çš„å­˜å‚¨ç»“æ„åˆ†åˆ«å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Name Column:</span><br><span class="line">data:      Introduction to Database SystemsAdvanced Topics in Database Systems</span><br><span class="line">offsets:   0, 32, 67</span><br><span class="line">length:    2</span><br><span class="line">nullCount: 0</span><br><span class="line">nullBitmap: </span><br><span class="line">| Byte 0   | Bytes 1-63 |</span><br><span class="line">|----------|------------|</span><br><span class="line">| 00000011 | 0 (padding)|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Instructor Column:</span><br><span class="line">data:      Daniel AbadiDaniel Abadi</span><br><span class="line">offsets:   0, 12, 24</span><br><span class="line">length:    2</span><br><span class="line">nullCount: 0</span><br><span class="line">nullBitmap:</span><br><span class="line">| Byte 0   | Bytes 1-63 |</span><br><span class="line">|----------|------------|</span><br><span class="line">| 00000011 | 0 (padding)|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Students Column</span><br><span class="line">data:                        AliceBobCharlieAndrewBeatrice</span><br><span class="line">students offsets:            0, 5, 8, 15, 21, 29</span><br><span class="line">students length:             5</span><br><span class="line">students nullCount:          0</span><br><span class="line">students nullBitmap:</span><br><span class="line">| Byte 0   | Bytes 1-63 |</span><br><span class="line">|----------|------------|</span><br><span class="line">| 00011111 | 0 (padding)|</span><br><span class="line">nested student list offsets:   0, 3, 5</span><br><span class="line">nested student list length:    2</span><br><span class="line">nested student list nullCount: 0</span><br><span class="line">nested student list nullBitmap:</span><br><span class="line">| Byte 0   | Bytes 1-63 |</span><br><span class="line">|----------|------------|</span><br><span class="line">| 00000011 | 0 (padding)|</span><br><span class="line"></span><br><span class="line">Year Column</span><br><span class="line">data:       2019|2019</span><br><span class="line">length:     2</span><br><span class="line">nullCount:  0</span><br><span class="line">nullBitmap:</span><br><span class="line">| Byte 0   | Bytes 1-63 |</span><br><span class="line">|----------|------------|</span><br><span class="line">| 00000011 | 0 (padding)|</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ Students åˆ—æœ¬èº«å°±æ˜¯åµŒå¥—æ•°æ®ç»“æ„ï¼Œè€Œå¤–å±‚çš„ Class è¡¨åŒ…å«äº† Students åˆ—ï¼Œå¯ä»¥çœ‹å‡ºè¿™ç§å·§æ€èƒ½æ”¯æŒæ— é™åµŒå¥—ï¼Œæ˜¯å¾ˆå€¼å¾—ç§°èµçš„è®¾è®¡ã€‚</p>
<h3 id="buffer-alignment-and-padding">Buffer alignment and padding</h3>
<p>Arrow åˆ—å­˜æ ¼å¼çš„æ‰€æœ‰å®ç°éƒ½éœ€è¦è€ƒè™‘æ•°æ®å†…å­˜åœ°å€çš„å¯¹é½ (alignment) ä»¥åŠå¡«å…… (padding)ï¼Œé€šå¸¸æ¨èå°†åœ°å€æŒ‰ 8 æˆ– 64 å­—èŠ‚å¯¹é½ï¼Œè‹¥ä¸è¶³ 8 æˆ– 64 å­—èŠ‚çš„æ•´æ•°å€åˆ™æŒ‰éœ€è¡¥å…¨ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†åˆ©ç”¨ç°ä»£ CPU çš„ SIMD æŒ‡ä»¤ï¼Œå°†è®¡ç®—å‘é‡åŒ–ã€‚</p>
<h2 id="memory-oriented-columnar-format">Memory-oriented columnar format</h2>
<p>è®¡ç®—æœºå‘å±•çš„å‡ åå¹´æ¥ï¼Œç»å¤§å¤šæ•°æ•°æ®å¼•æ“éƒ½é‡‡ç”¨è¡Œå­˜æ ¼å¼ï¼Œä¸»è¦åŸå› åœ¨äºæ—©æœŸçš„æ•°æ®åº”ç”¨è´Ÿè½½æ¨¡å¼åŸºæœ¬éƒ½é€ƒä¸å‡º<strong>å•ä¸ªå®ä½“çš„å¢åˆ æ”¹æŸ¥</strong>ã€‚é¢å¯¹æ­¤ç±»è´Ÿè½½ï¼Œå¦‚æœé‡‡ç”¨åˆ—å­˜æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œè¯»å–ä¸€ä¸ªå®ä½“æ•°æ®å°±éœ€è¦åœ¨å­˜å‚¨å™¨ä¸Šæ¥å›è·³è·ƒï¼Œæ‰¾åˆ°è¯¥å®ä½“çš„ä¸åŒå±æ€§ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨æ‰§è¡Œéšæœºè®¿é—®ã€‚ä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ•°æ®çš„å¢å¤šï¼Œè´Ÿè½½å˜å¾—æ›´åŠ å¤æ‚ï¼Œæ•°æ®åˆ†æçš„è´Ÿè½½æ¨¡å¼é€æ¸æ˜¾éœ²ï¼Œå³<strong>æ¯æ¬¡è®¿é—®ä¸€ç»„å®ä½“çš„å°‘æ•°å‡ ä¸ªå±æ€§</strong>ï¼Œç„¶åèšåˆå‡ºåˆ†æç»“æœï¼Œè¿™æ—¶å€™åˆ—å­˜æ ¼å¼çš„åœ°ä½ä¾¿é€æ¸æé«˜ã€‚</p>
<p>åœ¨ Hadoop ç”Ÿæ€ä¸­ï¼ŒApache Parquet å’Œ Apache ORC å·²ç»æˆä¸ºæœ€æµè¡Œçš„ä¸¤ç§æ–‡ä»¶å­˜å‚¨æ ¼å¼ï¼Œå®ƒä»¬æ ¸å¿ƒä»·å€¼ä¹Ÿæ˜¯å›´ç»•ç€åˆ—å­˜æ•°æ®æ ¼å¼å»ºç«‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜éœ€è¦ Arrowï¼Ÿè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦æ¥çœ‹å¾…æ•°æ®å­˜å‚¨ï¼š</p>
<ul>
<li>å­˜å‚¨æ ¼å¼ï¼šè¡Œå­˜ (row-wise/row-based)ã€åˆ—å­˜ (column-wise/column-based/columnar)</li>
<li>ä¸»è¦å­˜å‚¨å™¨ï¼šé¢å‘ç£ç›˜ (disk-oriented)ã€é¢å‘å†…å­˜ (memory-oriented)</li>
</ul>
<p>å°½ç®¡ä¸‰è€…éƒ½é‡‡ç”¨åˆ—å­˜æ ¼å¼ï¼Œä½† Parquet å’Œ ORC æ˜¯é¢å‘ç£ç›˜è®¾è®¡ï¼Œè€Œ Arrow æ˜¯é¢å‘å†…å­˜è®¾è®¡ã€‚ä¸ºäº†ç†è§£é¢å‘ç£ç›˜è®¾è®¡ä¸é¢å‘å†…å­˜è®¾è®¡çš„åŒºåˆ«ï¼Œæˆ‘ä»¬æ¥çœ‹ Daniel Abadi åšçš„ä¸€ä¸ª<a href="http://dbmsmusings.blogspot.com/2017/10/apache-arrow-vs-parquet-and-orc-do-we.html" target="_blank" rel="noopener">å®éªŒ</a>ã€‚</p>
<h3 id="daniel-abadi-çš„å®éªŒ">Daniel Abadi çš„å®éªŒ</h3>
<p>åœ¨ä¸€å° Amazon EC2 çš„ t2.medium å®ä¾‹ä¸Šï¼Œåˆ›å»ºä¸€å¼ åŒ…å« 60,000,000 è¡Œæ•°æ®çš„è¡¨ï¼Œæ¯è¡ŒåŒ…å« 6 ä¸ªå±æ€§ï¼Œæ¯ä¸ªå±æ€§å€¼éƒ½æ˜¯ int32 ç±»å‹çš„æ•°æ®ï¼Œå› æ­¤æ¯è¡Œéœ€è¦ 24 å­—èŠ‚ç©ºé—´ï¼Œæ•´å¼ è¡¨å ç”¨çº¦ 1.5GB ç©ºé—´ã€‚æˆ‘ä»¬å°†è¿™å¼ è¡¨åˆ†åˆ«ç”¨è¡Œå­˜æ ¼å¼å’Œåˆ—å­˜æ ¼å¼ä¿å­˜ä¸€ä»½ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªç®€å•çš„æŸ¥è¯¢ï¼šåœ¨ç¬¬ä¸€åˆ—ä¸­æŸ¥æ‰¾ä¸ç‰¹å®šå€¼ç›¸ç­‰çš„æ•°æ®ï¼Œå³ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> t.a = <span class="number">477638700</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸è®ºæ˜¯è¡Œå­˜è¿˜æ˜¯åˆ—å­˜ç‰ˆæœ¬ï¼ŒCPU çš„å·¥ä½œéƒ½æ˜¯è·å–æ•´æ•°ä¸ç›®æ ‡æ•´æ•°è¿›è¡Œæ¯”è¾ƒã€‚ä½†åœ¨è¡Œå­˜ç‰ˆæœ¬ä¸­æ‰§è¡Œè¯¥æŸ¥è¯¢éœ€è¦æ‰«ææ¯è¡Œï¼Œå³å…¨éƒ¨ 1.5GB æ•°æ®ï¼Œè€Œåœ¨åˆ—å­˜ç‰ˆæœ¬ä¸­æ‰§è¡Œè¯¥æŸ¥è¯¢åªéœ€æ‰«æç¬¬ä¸€åˆ—ï¼Œå³ 0.25GB æ•°æ®ï¼Œå› æ­¤åè€…çš„æ‰§è¡Œæ•ˆç‡ç†è®ºä¸Šåº”è¯¥æ˜¯å‰è€…çš„ 6 å€ã€‚ç„¶è€Œï¼Œå®é™…çš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/blog/2020/09/20/apache-arrow-summary/experiment-1.png" /></p>
<p>åˆ—å­˜ç‰ˆæœ¬ä¸è¡Œå­˜ç‰ˆæœ¬çš„æ€§èƒ½ç«Ÿç„¶ç›¸å·®æ— å‡ ï¼åŸå› åœ¨äºå®éªŒæ‰§è¡Œæ—¶å…³é—­äº†æ‰€æœ‰ CPU ä¼˜åŒ– (vectorization/SIMD processing)ï¼Œä½¿å¾—è¯¥æŸ¥è¯¢çš„ç“¶é¢ˆå‡ºç°åœ¨ CPU å¤„ç†ä¸Šã€‚æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æä¸€ä¸‹å…¶ä¸­çš„åŸå› ï¼šæ ¹æ®ç»éªŒï¼Œä»å†…å­˜æ‰«ææ•°æ®åˆ° CPU ä¸­çš„ååèƒ½è¾¾åˆ° 30GB/sï¼Œç°ä»£ CPU çš„å¤„ç†é¢‘ç‡èƒ½è¾¾åˆ° 3GHzï¼Œå³æ¯ç§’ 30 äº¿ CPUæŒ‡ä»¤ï¼Œå› æ­¤å³ä¾¿å¤„ç†å™¨å¯ä»¥åœ¨ä¸€ä¸ª CPU å‘¨æœŸæ‰§è¡Œ 32 ä½æ•´æ•°æ¯”è¾ƒï¼Œå®ƒçš„ååæœ€å¤šä¸º 12 GB/sï¼Œè¿œè¿œå°äºå†…å­˜è¾“é€æ•°æ®çš„ååã€‚å› æ­¤ä¸è®ºæ˜¯è¡Œå­˜è¿˜æ˜¯åˆ—å­˜ï¼Œä»å†…å­˜ä¸­è¾“é€ 0.25GB è¿˜æ˜¯ 1.5GB æ•°æ®åˆ° CPU ä¸­ï¼Œéƒ½ä¸ä¼šå¯¹ç»“æœæœ‰å¤§çš„å½±å“ã€‚</p>
<p>å¦‚æœæ‰“å¼€ CPU ä¼˜åŒ–é€‰é¡¹ï¼Œæƒ…å†µå°±å¤§ä¸ç›¸åŒã€‚å¯¹äºåˆ—å­˜æ•°æ®ï¼Œåªè¦è¿™äº›æ•´æ•°åœ¨å†…å­˜ä¸­è¿ç»­å­˜æ”¾ï¼Œç¼–è¯‘å™¨å¯ä»¥å°†ç®€å•çš„æ“ä½œå‘é‡åŒ–ï¼Œå¦‚ 32 ä½æ•´æ•°çš„æ¯”è¾ƒã€‚é€šå¸¸ï¼Œå‘é‡åŒ–åå¤„ç†å™¨åœ¨å•æ¡æŒ‡ä»¤ä¸­èƒ½å¤ŸåŒæ—¶å°† 4 ä¸ª 32 ä½æ•´æ•°ä¸æŒ‡å®šå€¼æ¯”è¾ƒã€‚ä¼˜åŒ–åå†æ‰§è¡Œç›¸åŒçš„æŸ¥è¯¢ï¼Œå®éªŒçš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/blog/2020/09/20/apache-arrow-summary/experiment-2.png" /></p>
<p>å¯ä»¥çœ‹åˆ°ä¸é¢„æœŸç›¸ç¬¦çš„ 4 å€å·®å¼‚ã€‚ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶ CPU ä»ç„¶æ˜¯ç“¶é¢ˆã€‚å¦‚æœå†…å­˜å¸¦å®½æ˜¯ç“¶é¢ˆçš„è¯ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿçœ‹åˆ°åˆ—å­˜ç‰ˆæœ¬ä¸è¡Œå­˜ç‰ˆæœ¬çš„æ€§èƒ½å·®å¼‚è¾¾åˆ° 6 å€ã€‚</p>
<p>ä»ä»¥ä¸Šå®éªŒå¯ä»¥çœ‹å‡ºï¼Œé’ˆå¯¹å°‘é‡å±æ€§çš„é¡ºåºæ‰«ææŸ¥è¯¢çš„å·¥ä½œè´Ÿè½½ï¼Œåˆ—å­˜æ ¼å¼è¦ä¼˜äºè¡Œå­˜æ ¼å¼ï¼Œè¿™ä¸æ•°æ®æ˜¯åœ¨ç£ç›˜ä¸Šè¿˜æ˜¯å†…å­˜ä¸­æ— å…³ï¼Œä½†å®ƒä»¬ä¼˜äºè¡Œå­˜æ ¼å¼çš„ç†ç”±ä¸åŒã€‚å¦‚æœä»¥ç£ç›˜ä¸ºä¸»è¦å­˜å‚¨ï¼ŒCPU çš„å¤„ç†é€Ÿåº¦è¦è¿œè¿œé«˜äºæ•°æ®ä»ç£ç›˜ç§»åŠ¨åˆ° CPU çš„é€Ÿåº¦ï¼Œåˆ—å­˜æ ¼å¼çš„ä¼˜åŠ¿åœ¨äºèƒ½é€šè¿‡æ›´é€‚åˆçš„å‹ç¼©ç®—æ³•å‡å°‘ç£ç›˜ IOï¼›å¦‚æœä»¥å†…å­˜ä¸ºä¸»è¦å­˜å‚¨ï¼Œæ•°æ®ç§»åŠ¨é€Ÿåº¦çš„å½±å“å°†å˜å¾—å¾®ä¸è¶³é“ï¼Œæ­¤æ—¶åˆ—å­˜æ ¼å¼çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨å‘é‡åŒ–å¤„ç†ã€‚</p>
<p>è¿™ä¸ªå®éªŒå‘Šè¯‰æˆ‘ä»¬ï¼š<strong>æ•°æ®å­˜å‚¨æ ¼å¼çš„è®¾è®¡å†³å®šåœ¨ä¸åŒç“¶é¢ˆä¸‹çš„ç›®çš„ä¸åŒ</strong>ã€‚æœ€å…¸å‹çš„å°±æ˜¯å‹ç¼©ï¼Œå¯¹äº disk-oriented åœºæ™¯ï¼Œæ›´é«˜çš„å‹ç¼©ç‡å‡ ä¹æ€»æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œåˆ©ç”¨è®¡ç®—èµ„æºæ¢å–ç©ºé—´å¯ä»¥åˆ©ç”¨æ›´å¤šçš„ CPU èµ„æºï¼Œå‡è½»ç£ç›˜ IO çš„å‹åŠ›ï¼›å¯¹äº memory-oriented åœºæ™¯ï¼Œå‹ç¼©åªä¼šè®© CPU æ›´åŠ ä¸å ªé‡è´Ÿã€‚</p>
<h3 id="apache-parquetorc-vs.-apache-arrow">Apache Parquet/ORC vs. Apache Arrow</h3>
<p>ç°åœ¨è¦å¯¹æ¯” Parquet/ORC ä¸ Arrow å°±å˜å¾—å®¹æ˜“ä¸€äº›ã€‚å› ä¸º Parquet å’Œ ORC æ˜¯ä¸ºç£ç›˜è€Œè®¾è®¡ï¼Œæ”¯æŒé«˜å‹ç¼©ç‡çš„å‹ç¼©ç®—æ³•ï¼Œå¦‚ snappyã€gzipã€zlib ç­‰å‹ç¼©æŠ€æœ¯å°±ååˆ†å¿…è¦ã€‚è€Œ Arrow ä¸ºå†…å­˜è€Œè®¾è®¡ï¼Œå¯¹å‹ç¼©ç®—æ³•å‡ ä¹æ²¡æœ‰è¦æ±‚ï¼Œæ›´å€¾å‘äºç›´æ¥å­˜å‚¨åŸç”Ÿçš„äºŒè¿›åˆ¶æ•°æ®ã€‚é¢å‘ç£ç›˜ä¸é¢å‘å†…å­˜çš„å¦ä¸€ä¸ªä¸åŒç‚¹åœ¨äºï¼šå°½ç®¡ç£ç›˜å’Œå†…å­˜çš„é¡ºåºè®¿é—®æ•ˆç‡éƒ½è¦é«˜äºéšæœºè®¿é—®ï¼Œä½†åœ¨ç£ç›˜ä¸­ï¼Œè¿™ä¸ªå·®å¼‚åœ¨ 2-3 ä¸ªæ•°é‡çº§ï¼Œè€Œåœ¨å†…å­˜ä¸­é€šå¸¸åœ¨ 1 ä¸ªæ•°é‡çº§å†…ã€‚å› æ­¤è¦å‡æ‘Šä¸€æ¬¡éšæœºè®¿é—®çš„æˆæœ¬ï¼Œéœ€è¦åœ¨ç£ç›˜ä¸­è¿ç»­è¯»å–ä¸Šåƒæ¡æ•°æ®ï¼Œè€Œåœ¨å†…å­˜ä¸­ä»…éœ€è¦è¿ç»­è¯»å–åæ¡å·¦å³çš„æ•°æ®ã€‚è¿™ç§å·®å¼‚æ„å‘³ç€ å†…å­˜åœºæ™¯ä¸‹çš„ batch å¤§å° (å¦‚ Arrow çš„ 64KB) è¦å°äºç£ç›˜åœºæ™¯ä¸‹çš„ batch å¤§å°ã€‚</p>
<h2 id="tidb-ä¸ºä»€ä¹ˆè¦å‚è€ƒ-arrow">TiDB ä¸ºä»€ä¹ˆè¦å‚è€ƒ Arrow</h2>
<p>TiDB æœ¬èº«å°±æ˜¯åŸºäºå†…å­˜çš„è®¡ç®—å¼•æ“ï¼Œé‚£ä¹ˆæ—¢ç„¶ TiDB æœ‰æ„å‘ HTAP æ–¹å‘å‘å±•ï¼ŒAP åœºæ™¯è‡ªç„¶ä¹Ÿæ˜¯å®ƒçš„ç›®æ ‡åœºæ™¯ã€‚æ—¢ç„¶ Arrow çš„åˆ—å­˜æ ¼å¼æ˜¯è¿™ä¸ªé¢†åŸŸçš„äº‹å®æ ‡å‡†ï¼Œé‚£ä¹ˆæ‹¥æŠ±è¡Œä¸šæ ‡å‡†ä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸éš¾åšçš„å†³å®šäº†ï¼</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="http://dbmsmusings.blogspot.com/2017/10/apache-arrow-vs-parquet-and-orc-do-we.html" target="_blank" rel="noopener">DBMS Musings: Apache Arrow vs. Parquet and ORC: Do we really need a third Apache project for columnar data representation?</a></li>
<li><a href="http://dbmsmusings.blogspot.com/2017/10/apache-arrow-vs-parquet-and-orc-do-we.html" target="_blank" rel="noopener">DBMS Musings: An analysis of the strengths and weaknesses of Apache Arrow</a></li>
<li><a href="https://www.dremio.com/origin-history-of-apache-arrow/" target="_blank" rel="noopener">Dremio blog: The Origin &amp; History of Apache Arrow</a></li>
<li><a href="https://www.youtube.com/watch?v=fyj4FyH3XdU" target="_blank" rel="noopener">ACM: Apache Arrow and the Future of Data Frames</a>, <a href="https://learning.acm.org/binaries/content/assets/leaning-center/webinar-slides/2020/wesmckinney_techtalk_slides.pdf" target="_blank" rel="noopener">slides</a></li>
<li><a href="https://arrow.apache.org/docs/" target="_blank" rel="noopener">Apache Arrow: official docs</a>, <a href="https://arrow.apache.org/committers/" target="_blank" rel="noopener">committers</a></li>
<li><a href="http://www.vldb.org/pvldb/vol13/p3072-huang.pdf" target="_blank" rel="noopener">TiDB: A Raft-based HTAP Database</a></li>
<li><a href="https://pingcap.com/blog-cn/tidb-source-code-reading-10/" target="_blank" rel="noopener">TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç«  (å) Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹</a></li>
</ul>

    </div>

    
    
    
        

  <div class="followme">
    <p>æ¬¢è¿å…³æ³¨æˆ‘çš„å…¶å®ƒå‘å¸ƒæ¸ é“</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="/blog/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/database/" rel="tag"># database</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2020/07/21/the-anatomy-of-a-large-scale-hypertextual-web-search-engine-1998/" rel="prev" title="The Anatomy of a Large-Scale Hypertextual Web Search Engine (1998)">
      <i class="fa fa-chevron-left"></i> The Anatomy of a Large-Scale Hypertextual Web Search Engine (1998)
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2020/10/05/Go-Error-Handling-Research/" rel="next" title="Go Error Handling æ–¹æ¡ˆè°ƒç ”">
      Go Error Handling æ–¹æ¡ˆè°ƒç ” <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#é¡¹ç›®ç®€ä»‹"><span class="nav-number">1.</span> <span class="nav-text">é¡¹ç›®ç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åŸºäºå†…å­˜çš„åˆ—å­˜æ ¼å¼"><span class="nav-number">2.</span> <span class="nav-text">åŸºäºå†…å­˜çš„åˆ—å­˜æ ¼å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fixed-width-data-types"><span class="nav-number">2.1.</span> <span class="nav-text">Fixed-width data types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#variable-width-data-types"><span class="nav-number">2.2.</span> <span class="nav-text">Variable-width data types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nested-data"><span class="nav-number">2.3.</span> <span class="nav-text">Nested Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buffer-alignment-and-padding"><span class="nav-number">2.4.</span> <span class="nav-text">Buffer alignment and padding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#memory-oriented-columnar-format"><span class="nav-number">3.</span> <span class="nav-text">Memory-oriented columnar format</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#daniel-abadi-çš„å®éªŒ"><span class="nav-number">3.1.</span> <span class="nav-text">Daniel Abadi çš„å®éªŒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#apache-parquetorc-vs.-apache-arrow"><span class="nav-number">3.2.</span> <span class="nav-text">Apache Parquet&#x2F;ORC vs. Apache Arrow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tidb-ä¸ºä»€ä¹ˆè¦å‚è€ƒ-arrow"><span class="nav-number">4.</span> <span class="nav-text">TiDB ä¸ºä»€ä¹ˆè¦å‚è€ƒ Arrow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZhengHe"
      src="/blog/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">ZhengHe</p>
  <div class="site-description" itemprop="description">éƒ‘é¹¤çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ZhengHe-MD" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;ZhengHe-MD" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ranchardzheng@gmail.com" title="E-Mail â†’ mailto:ranchardzheng@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZhengHe</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/pisces.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://zhenghe-hexo-blog.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://zhenghe-md.github.io/blog/2020/09/20/apache-arrow-summary/";
    this.page.identifier = "2020/09/20/apache-arrow-summary/";
    this.page.title = "Apache Arrow å°ç»“";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://zhenghe-hexo-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
